<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Consult</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; padding-bottom: 80px; }
    .hidden { display: none !important; }
    
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .unauth-box { text-align: center; padding: 40px 20px; background-color: #fff; border-radius: 15px; margin-top: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .uid-display { background: #f1f3f5; color: #495057; padding: 15px; font-family: monospace; word-break: break-all; margin: 20px 0; border: 1px dashed #ced4da; }

    .header-bar { background: white; padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 20px; border-radius: 0 0 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eaeaea; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
    .nav-item { text-align: center; color: #adb5bd; width: 25%; cursor: pointer; padding-top: 8px; }
    .nav-item.active { color: #0d6efd; font-weight: bold; }
    .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 2px; }
    
    .search-results { position: absolute; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .cursor-pointer { cursor: pointer; }
    .clickable-edit { cursor: pointer; border-bottom: 1px dashed #ccc; }
    .clickable-edit:hover { color: #0d6efd; border-bottom-color: #0d6efd; }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h6 class="mt-3 text-secondary">Loading System...</h6>
  </div>

  <div class="container" style="max-width: 600px; padding: 0;">

    <div id="unauth-screen" class="container px-4 hidden">
      <div class="unauth-box">
        <h1 class="text-danger"><i class="bi bi-shield-lock"></i></h1>
        <h4>Access Denied</h4>
        <div class="uid-display" id="show-uid">...</div>
        <button onclick="copyUID()" class="btn btn-outline-primary w-100 mb-3">Copy UserID</button>
        <button onclick="location.reload()" class="btn btn-primary w-100 btn-lg">Refresh</button>
      </div>
    </div>

    <div id="main-app" class="hidden">
        
        <div class="header-bar d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">แพทย์ผู้ตรวจ</small>
                <h5 class="m-0 text-primary fw-bold"><i class="bi bi-person-circle"></i> <span id="header-doc-name">...</span></h5>
            </div>
            <button onclick="location.reload()" class="btn btn-light btn-sm text-muted"><i class="bi bi-arrow-clockwise"></i></button>
        </div>

        <div class="container px-3 pb-5">

            <div id="tab-input" class="page-section">
                <form id="consult-form">
                    <div class="card mb-3 border-0 shadow-sm bg-white">
                        <div class="card-body py-3">
                            <label class="fw-bold small text-muted text-uppercase mb-2">Specialty</label>
                            <div id="specialty-container"></div>
                        </div>
                    </div>

                    <div id="div-gi-diag" class="card mb-3 border-0 shadow-sm bg-white hidden">
                        <div class="card-body py-3 border-start border-4 border-warning">
                            <label class="fw-bold text-warning mb-2">GI Diagnosis</label>
                            <select id="gi-diagnosis" class="form-select">
                                <option value="" selected disabled>-- เลือก Diagnosis --</option>
                                <option value="UGIB">UGIB</option>
                                <option value="Other GI bleed">Other GI bleed</option>
                                <option value="Non GI bleed">Non GI bleed</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted text-uppercase">Visit Type</label>
                        <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="visitType" id="v1" value="First visit" checked onchange="toggleMode()">
                            <label class="btn btn-outline-primary" for="v1">First Visit</label>
                            <input type="radio" class="btn-check" name="visitType" id="v2" value="Follow up visit" onchange="toggleMode()">
                            <label class="btn btn-outline-primary" for="v2">Follow Up</label>
                        </div>
                    </div>

                    <div class="mb-3">
                          <label class="small text-muted">Date (วันที่ตรวจ)</label>
                          <input type="date" id="visit-date" class="form-control">
                    </div>
                  
                    <div id="mode-scan" class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">New Case (Photo)</label>
                        <div class="d-flex gap-2">
                            <label class="btn btn-warning w-50 py-3 shadow-sm text-dark fw-bold position-relative">
                                <i class="bi bi-camera-fill fs-4 d-block"></i> ถ่ายรูป
                                <input type="file" id="camInput" accept="image/*" capture="environment" 
                                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"
                                       onchange="processFile(this)">
                            </label>
                            <label class="btn btn-outline-secondary w-50 py-3 shadow-sm fw-bold position-relative">
                                <i class="bi bi-images fs-4 d-block"></i> อัลบั้ม
                                <input type="file" id="galInput" accept="image/*"
                                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"
                                       onchange="processFile(this)">
                            </label>
                        </div>
                        <div class="form-text text-muted mt-2 small text-center">* ถ่ายรูปปุ๊บ ระบบจะอ่านให้อัตโนมัติ</div>
                        <div class="text-center mt-2 position-relative">
                            <img id="preview" class="hidden shadow-sm border" style="max-width: 100%; border-radius: 8px;">
                        </div>
                        <button type="button" id="btn-scan" class="btn btn-secondary w-100 mt-2 hidden" disabled>รอรูปภาพ...</button>
                        <button type="button" onclick="openExternal()" class="btn btn-outline-secondary w-100 mt-3 btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> เปิดใน Browser
                        </button>
                    </div>

                    <div id="mode-search" class="mb-3 hidden position-relative">
                        <label class="form-label fw-bold small text-muted text-uppercase">Search Patient</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" id="patient-search" class="form-control" placeholder="ค้นหาชื่อ หรือ HN..." onkeyup="filterPatients()">
                        </div>
                        <div id="search-results" class="search-results hidden"></div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-12"><label class="small text-muted">ชื่อ-นามสกุล</label><input type="text" id="p-name" class="form-control" placeholder="ระบุชื่อคนไข้" required></div>
                        <div class="col-12"><label class="small text-muted">HN</label><input type="text" id="p-hn" class="form-control" placeholder="ระบุเลข HN" required></div>
                        
                        <div class="col-6">
                            <label class="small text-muted">Ward (ตึก/ชั้น)</label>
                            <input type="text" id="p-ward" class="form-control" placeholder="ระบุ Ward">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Note (เตือนความจำ)</label>
                            <input type="text" id="p-note" class="form-control" placeholder="Optional">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 btn-lg shadow fw-bold mb-5">บันทึกข้อมูล <i class="bi bi-save"></i></button>
                </form>
            </div>

            <div id="tab-history" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0"><i class="bi bi-person-lines-fill"></i> ผู้ป่วยในความดูแล</h5>
                    <button class="btn btn-sm btn-light text-primary" onclick="loadMyPatients()"><i class="bi bi-arrow-clockwise"></i></button>
                </div>

                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-2 bg-light rounded">
                        <div class="row g-2">
                            <div class="col-5">
                                <select id="filter-status" class="form-select form-select-sm" onchange="renderPatientList()">
                                    <option value="Active">Active Only</option>
                                    <option value="All">All Status</option>
                                    <option value="Offservice">Offservice</option>
                                </select>
                            </div>
                            <div class="col-7">
                                <select id="filter-ward" class="form-select form-select-sm" onchange="renderPatientList()">
                                    <option value="All" selected>All Wards</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="patient-list-container" class="pb-5"></div>
                <p id="no-patients" class="text-center text-muted mt-5 hidden">ไม่พบรายชื่อผู้ป่วย</p>
            </div>

            <div id="tab-dashboard" class="page-section hidden">
                <h5 class="fw-bold mb-3"><i class="bi bi-graph-up-arrow"></i> สรุปข้อมูล</h5>
                
                <div class="card mb-3 border-0 shadow-sm bg-white">
                    <div class="card-header bg-white fw-bold">สถิติของฉัน (Personal)</div>
                    <div class="card-body">
                         <h1 class="display-4 fw-bold text-primary mb-2 text-center" id="chart-total">0</h1>
                         <p class="text-center text-muted small">เคสทั้งหมดในปีนี้</p>
                         <canvas id="barChart" style="max-height: 200px;"></canvas>
                    </div>
                </div>

                <div class="card mb-3 border-0 shadow-sm bg-white">
                    <div class="card-header bg-white fw-bold text-danger">
                        <i class="bi bi-trophy"></i> ภาพรวมภาควิชา (Competitive)
                    </div>
                    <div class="card-body">
                         <canvas id="compChart" style="max-height: 250px;"></canvas>
                         <div class="text-center mt-2 small text-muted">เปรียบเทียบจำนวนเคสแต่ละแผนก (รายเดือน)</div>
                    </div>
                </div>
            </div>

            <div id="tab-activity" class="page-section hidden">
                <h5 class="fw-bold mb-3"><i class="bi bi-journal-bookmark"></i> บันทึกกิจกรรม</h5>
                <form id="activity-form">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <label class="form-label fw-bold">เลือกกิจกรรม</label>
                            <select id="act-name" class="form-select mb-3" required>
                                <option value="" selected disabled>-- เลือกกิจกรรม --</option>
                            </select>

                            <label class="form-label fw-bold">วันที่เข้าร่วม</label>
                            <input type="date" id="act-date" class="form-control mb-3" required>

                            <label class="form-label fw-bold">บทบาท (Role)</label>
                            <select id="act-role" class="form-select mb-3">
                                <option value="Attendance" selected>Attendance (ผู้เข้าร่วม)</option>
                                <option value="Moderator">Moderator (ผู้ดำเนินรายการ)</option>
                                <option value="Presenter">Presenter (ผู้นำเสนอ)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2 shadow fw-bold">
                        <i class="bi bi-check-circle"></i> บันทึก Activity
                    </button>
                </form>
            </div>

        </div> 
    </div> 

  </div>

  <div id="bottom-nav" class="bottom-nav hidden">
    <div class="nav-item active" id="nav-input" onclick="switchTab('input')"><i class="bi bi-pencil-square"></i><span>บันทึก</span></div>
    <div class="nav-item" id="nav-history" onclick="switchTab('history')"><i class="bi bi-person-lines-fill"></i><span>ผู้ป่วย</span></div>
    <div class="nav-item" id="nav-dashboard" onclick="switchTab('dashboard')"><i class="bi bi-pie-chart"></i><span>สรุป</span></div>
    <div class="nav-item" id="nav-activity" onclick="switchTab('activity')"><i class="bi bi-journal-bookmark"></i><span>กิจกรรม</span></div>
  </div>

  <div class="modal fade" id="wardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
            <h6 class="modal-title fw-bold">แก้ไขข้อมูล / Note</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-hn">
            
            <label class="small text-muted mb-1">Ward Name:</label>
            <input type="text" id="edit-ward-input" class="form-control mb-2" placeholder="Ex. 5C, ICU, 9B...">
            <div class="d-flex gap-2 overflow-auto py-1 mb-3" id="quick-wards"></div>
            
            <label class="small text-muted mb-1">Note (บันทึกช่วยจำ):</label>
            <textarea id="edit-note-input" class="form-control" rows="2" placeholder="Note เพิ่มเติม..."></textarea>
        </div>
        <div class="modal-footer p-2">
            <button type="button" class="btn btn-primary w-100" onclick="saveWardChange()">บันทึก</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ************************************************
    const WEB_APP_URL = 'https://smart-consult-api-890183822347.asia-southeast3.run.app'; 
    const LIFF_ID = '2008753162-pqFRi41y'; 
    // ************************************************

    const ACTIVITY_LIST = [
        "Interesting Case Conference", "Admission Conference", "Morbidity and Mortality", 
        "Journal Club", "Topic Conference", "Grand round", "Grand round (หน่วย)", 
        "Supervision ward round", "Pathology Conference", "X-ray and Film Conference", 
        "Scientific Symposiums", "Review OPD Card"
    ];

    let currentDoctor = null;
    let existingPatients = [];
    let allDoctors = [];
    let base64String = "";
    let barChart = null;
    let compChart = null;
    let myPatientsRaw = []; 
    let dashData = { personal: [], competitive: {} };
    let wardModal = null; // Store modal instance

    if(typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

    window.onload = async function() {
      // Init Activity Dropdown
      const actSel = document.getElementById('act-name');
      ACTIVITY_LIST.forEach(act => {
          actSel.innerHTML += `<option value="${act}">${act}</option>`;
      });
      document.getElementById('act-date').valueAsDate = new Date();

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        initApp(profile.userId);
      } catch (err) { console.error(err); }
    };

    function initApp(uid) {
        fetch(`${WEB_APP_URL}?action=loadApp&uid=${uid}`)
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                currentDoctor = res.doctor;
                currentDoctor.uid = uid; 
                existingPatients = res.patients;
                allDoctors = res.doctors;
                startApp();
            } else {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('unauth-screen').classList.remove('hidden');
                document.getElementById('show-uid').innerText = res.uid || uid; 
            }
        });
    }

    function startApp() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('unauth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.remove('hidden');
        document.getElementById('header-doc-name').innerText = currentDoctor.name;
        document.getElementById('visit-date').valueAsDate = new Date();

        const container = document.getElementById('specialty-container'); 
        container.innerHTML = "";
        currentDoctor.specialties.forEach((spec, i) => {
            const div = document.createElement('div');
            div.className = "form-check form-check-inline";
            div.innerHTML = `<input class="form-check-input" type="radio" name="specialty" value="${spec.trim()}" id="spec-${i}" ${i===0?'checked':''} onchange="checkGI()"><label class="form-check-label" for="spec-${i}">${spec.trim()}</label>`;
            container.appendChild(div);
        });
        checkGI();
    }

    window.switchTab = function(tab) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.getElementById('nav-' + tab).classList.add('active');
        
        if(tab === 'history') loadMyPatients(); 
        if(tab === 'dashboard') loadDashboard();
        window.scrollTo(0,0);
    }

    function loadMyPatients() {
       const listContainer = document.getElementById('patient-list-container'); 
       listContainer.innerHTML = '<div class="text-center mt-4"><span class="spinner-border text-primary"></span></div>';
       fetch(`${WEB_APP_URL}?action=getMyPatients&uid=${currentDoctor.uid}`)
       .then(r => r.json())
       .then(data => {
           myPatientsRaw = data;
           updateWardFilterOptions();
           renderPatientList();
       });
    }

    function updateWardFilterOptions() {
        const wards = new Set();
        myPatientsRaw.forEach(p => { if(p.ward && String(p.ward).trim()!=='-') wards.add(String(p.ward).trim()); });
        const sel = document.getElementById('filter-ward');
        const oldVal = sel.value;
        sel.innerHTML = '<option value="All">All Wards</option>';
        Array.from(wards).sort().forEach(w => sel.innerHTML += `<option value="${w}">${w}</option>`);
        if(oldVal && oldVal !== 'All') sel.value = oldVal; 
    }

    function renderPatientList() {
        const fStatus = document.getElementById('filter-status').value;
        const fWard = document.getElementById('filter-ward').value;
        const container = document.getElementById('patient-list-container');
        container.innerHTML = "";

        const filtered = myPatientsRaw.filter(p => {
            if (fStatus !== 'All' && String(p.status).toLowerCase() !== fStatus.toLowerCase()) return false;
            if (fWard !== 'All' && String(p.ward).trim() !== String(fWard).trim()) return false;
            return true;
        });

        if (filtered.length === 0) { document.getElementById('no-patients').classList.remove('hidden'); return; }
        document.getElementById('no-patients').classList.add('hidden');

        filtered.forEach(p => {
            const isActive = String(p.status).toLowerCase() === 'active';
            
            // Safe Strings for onClick
            const safeWard = (p.ward||'').replace(/'/g, "\\'");
            const safeNote = (p.note||'').replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, " ");

            container.innerHTML += `
                <div class="card mb-2 border-0 shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between">
                            <div style="width:70%">
                                <span class="badge ${isActive?'bg-success':'bg-secondary'}">${p.status}</span>
                                <span class="fw-bold ms-1 text-primary clickable-edit" onclick="openWardModal('${p.hn}', '${safeWard}', '${safeNote}')"><i class="bi bi-geo-alt-fill"></i> ${p.ward||'-'}</span>
                                <h6 class="mb-0 fw-bold mt-1">${p.name}</h6>
                                <small class="text-muted">HN: ${p.hn}</small>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-light border" onclick="selectHistory('${p.name}','${p.hn}','${safeWard}','${safeNote}')">Follow</button>
                                <button class="btn btn-sm ${isActive?'btn-outline-danger':'btn-outline-success'} mt-1" onclick="toggleStatus('${p.hn}','${p.status}')">${isActive?'Offservice':'Active'}</button>
                            </div>
                        </div>
                        <div class="mt-2 p-2 bg-light border rounded small clickable-edit" onclick="openWardModal('${p.hn}', '${safeWard}', '${safeNote}')">
                            <i class="bi bi-pencil"></i> ${p.note ? p.note : '<span class="text-muted fst-italic">Add note...</span>'}
                        </div>
                    </div>
                </div>`;
        });
    }

    window.toggleStatus = function(hn, status) {
        const newStatus = status === 'Active' ? 'Offservice' : 'Active';
        if(!confirm(`เปลี่ยนสถานะเป็น ${newStatus}?`)) return;
        
        fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action:'updateStatus', payload:{hn, status: newStatus}}) });
        // Update Local
        const p = myPatientsRaw.find(x=>x.hn==hn); if(p) p.status = newStatus; 
        renderPatientList();
    }
    
    // Modal Functions
    window.openWardModal = function(hn, currentWard, currentNote) {
        if(!wardModal) wardModal = new bootstrap.Modal(document.getElementById('wardModal'));
        document.getElementById('edit-hn').value = hn;
        document.getElementById('edit-ward-input').value = (currentWard === '-' || currentWard === 'null' ? '' : currentWard);
        document.getElementById('edit-note-input').value = (currentNote === 'undefined' || !currentNote) ? '' : currentNote;
        
        // Quick Wards
        const quickBox = document.getElementById('quick-wards');
        quickBox.innerHTML = "";
        const existingWards = Array.from(document.getElementById('filter-ward').options).map(o=>o.value).filter(v=>v!=='All');
        existingWards.forEach(w => {
            quickBox.innerHTML += `<span class="badge bg-light text-dark border cursor-pointer me-1" onclick="document.getElementById('edit-ward-input').value='${w}'">${w}</span>`;
        });
        
        wardModal.show();
    }

    window.saveWardChange = function() {
        const hn = document.getElementById('edit-hn').value;
        const newWard = document.getElementById('edit-ward-input').value || '-';
        const newNote = document.getElementById('edit-note-input').value;
        
        const p = myPatientsRaw.find(x => x.hn == hn);
        if(p) { p.ward = newWard; p.note = newNote; }
        
        renderPatientList();
        wardModal.hide();

        fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'updateStatus', payload: { hn: hn, status: p.status, ward: newWard, note: newNote } })
        });
    }

    window.selectHistory = function(n, h, w, note) { 
        switchTab('input'); document.getElementById('v2').click();
        document.getElementById('p-name').value=n; document.getElementById('p-hn').value=h;
        document.getElementById('p-ward').value=w; document.getElementById('p-note').value=note;
    }

    // --- DASHBOARD & GRAPH ---
    function loadDashboard() { 
        fetch(`${WEB_APP_URL}?action=getDashboardData&uid=${currentDoctor.uid}`)
        .then(r => r.json())
        .then(d => { 
            dashData = d; 
            renderCharts(); 
        }); 
    }

    function renderCharts() {
        // 1. Personal Bar Chart
        const personalLogs = dashData.personal || [];
        document.getElementById('chart-total').innerText = personalLogs.length;
        
        let firstData = Array(12).fill(0), fuData = Array(12).fill(0);
        personalLogs.forEach(l => {
            const d = new Date(l.date);
            if(!isNaN(d)) {
                const m = d.getMonth();
                const t = (l.type||"").toLowerCase();
                if(t.includes('first')||t.includes('new')) firstData[m]++; else fuData[m]++;
            }
        });

        const ctx1 = document.getElementById('barChart');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                datasets: [
                    { label: 'New', data: firstData, backgroundColor: '#0d6efd' },
                    { label: 'F/U', data: fuData, backgroundColor: '#9ec5fe' }
                ]
            },
            options: { responsive: true, scales: { x:{stacked:true}, y:{stacked:true} } }
        });

        // 2. Competitive Line Chart
        const compData = dashData.competitive || {};
        const ctx2 = document.getElementById('compChart');
        const labels = Object.keys(compData).sort(); 
        const specs = new Set();
        Object.values(compData).forEach(m => Object.keys(m).forEach(s => specs.add(s)));
        const specsArr = Array.from(specs);

        const datasets = specsArr.map((spec, i) => {
            const data = labels.map(lbl => compData[lbl][spec] || 0);
            const color = `hsl(${(i * 360) / specsArr.length}, 70%, 50%)`;
            return { label: spec, data: data, borderColor: color, backgroundColor: color, tension: 0.3, fill: false };
        });

        if(compChart) compChart.destroy();
        compChart = new Chart(ctx2, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: { responsive: true, interaction: { mode: 'index', intersect: false } }
        });
    }

    // --- ACTIVITY SAVE ---
    document.getElementById('activity-form').onsubmit = function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = "Saving..."; btn.disabled = true;

        const payload = {
            activity: document.getElementById('act-name').value,
            date: document.getElementById('act-date').value,
            role: document.getElementById('act-role').value,
            uid: currentDoctor.uid,
            doctorName: currentDoctor.name,
            specialty: currentDoctor.specialties[0]
        };

        fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveActivity', payload: payload })
        })
        .then(r => r.json())
        .then(res => {
            alert("✅ บันทึก Activity เรียบร้อย!");
            btn.innerHTML = oldText; btn.disabled = false;
            document.getElementById('activity-form').reset();
            document.getElementById('act-date').valueAsDate = new Date();
        })
        .catch(err => { alert("Error: " + err); btn.innerHTML = oldText; btn.disabled = false; });
    }

    // --- STANDARD FUNCTIONS (SCAN, SEARCH) ---
    window.processFile = function(input) {
        const f = input.files[0]; if(!f) return;
        document.getElementById('btn-scan').classList.remove('hidden');
        const r = new FileReader();
        r.onload = function(e) {
            const i = new Image();
            i.onload = function() {
                const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                c.width = 800; c.height = i.height*(800/i.width);
                ctx.drawImage(i,0,0,c.width,c.height);
                base64String = c.toDataURL('image/jpeg',0.7).split(',')[1];
                document.getElementById('preview').src = c.toDataURL(); document.getElementById('preview').classList.remove('hidden');
                scanImage();
            }; i.src = e.target.result;
        }; r.readAsDataURL(f);
    }
    window.scanImage = function() {
        document.getElementById('btn-scan').innerHTML = 'AI Processing...';
        fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'analyze', image:base64String})})
        .then(r=>r.json()).then(res=>{
            document.getElementById('p-name').value = res.name||""; document.getElementById('p-hn').value = res.hn||""; if(res.ward) document.getElementById('p-ward').value=res.ward;
            document.getElementById('btn-scan').innerText = "Done";
        }).catch(()=>{ document.getElementById('btn-scan').innerText = "Failed"; });
    }
    window.openExternal = function() { if(liff.isInClient()) liff.openWindow({url:window.location.href, external:true}); }
    
    window.toggleMode = function() {
        const type = document.querySelector('input[name="visitType"]:checked').value;
        if(type.includes('First')) { document.getElementById('mode-scan').classList.remove('hidden'); document.getElementById('mode-search').classList.add('hidden'); } 
        else { document.getElementById('mode-scan').classList.add('hidden'); document.getElementById('mode-search').classList.remove('hidden'); }
    }
    
    window.checkGI = function() {
        const selected = document.querySelector('input[name="specialty"]:checked');
        const giDiv = document.getElementById('div-gi-diag');
        if (selected && (selected.value.toUpperCase().includes('GI'))) giDiv.classList.remove('hidden');
        else giDiv.classList.add('hidden');
    }

    window.filterPatients = function() {
       const q = document.getElementById('patient-search').value.toLowerCase();
       const box = document.getElementById('search-results'); box.innerHTML="";
       if(q.length < 2) { box.classList.add('hidden'); return; }
       const found = existingPatients.filter(p => p.name.toLowerCase().includes(q) || String(p.hn).includes(q));
       box.classList.remove('hidden');
       found.forEach(p => box.innerHTML += `<div class="search-item" onclick="fillPatient('${p.name}','${p.hn}')">${p.name} (${p.hn})</div>`);
    }
    window.fillPatient = function(n,h){ document.getElementById('p-name').value=n; document.getElementById('p-hn').value=h; document.getElementById('search-results').classList.add('hidden'); }
    
    document.getElementById('consult-form').onsubmit = function(e) {
        e.preventDefault();
        const hn = document.getElementById('p-hn').value;
        if(!hn) { alert("ระบุ HN"); return; }
        
        const payload = {
            doctorName: currentDoctor.name,
            specialty: document.querySelector('input[name="specialty"]:checked').value,
            patientName: document.getElementById('p-name').value,
            hn: hn,
            visitType: document.querySelector('input[name="visitType"]:checked').value,
            diagnosis: document.getElementById('div-gi-diag').classList.contains('hidden') ? "" : document.getElementById('gi-diagnosis').value,
            ward: document.getElementById('p-ward').value,
            note: document.getElementById('p-note').value
        };
        fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'save', payload:payload})}).then(r=>r.json()).then(()=>{ alert("Saved!"); location.reload(); });
    }

  </script>
</body>
</html>
