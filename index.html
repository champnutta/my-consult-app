<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Consultation Log</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; padding-bottom: 80px; }
    .hidden { display: none !important; }
    
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .unauth-box { text-align: center; padding: 40px 20px; background-color: #fff; border-radius: 15px; margin-top: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .uid-display { background: #f1f3f5; color: #495057; padding: 15px; font-family: monospace; word-break: break-all; margin: 20px 0; border: 1px dashed #ced4da; }

    .header-bar { background: white; padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 20px; border-radius: 0 0 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eaeaea; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
    .nav-item { text-align: center; color: #adb5bd; width: 33%; cursor: pointer; padding-top: 8px; }
    .nav-item.active { color: #0d6efd; font-weight: bold; }
    .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 2px; }
    
    .search-results { position: absolute; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h6 class="mt-3 text-secondary">Loading System...</h6>
  </div>

  <div class="container" style="max-width: 600px; padding: 0;">

    <div id="unauth-screen" class="container px-4 hidden">
      <div class="unauth-box">
        <h1 class="text-danger"><i class="bi bi-shield-lock"></i></h1>
        <h4>Access Denied</h4>
        <div class="uid-display" id="show-uid">...</div>
        <button onclick="copyUID()" class="btn btn-outline-primary w-100 mb-3">Copy UserID</button>
        <button onclick="location.reload()" class="btn btn-primary w-100 btn-lg">Refresh</button>
      </div>
    </div>

    <div id="main-app" class="hidden">
        
        <div class="header-bar d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</small>
                <h5 class="m-0 text-primary fw-bold"><i class="bi bi-person-circle"></i> <span id="header-doc-name">...</span></h5>
            </div>
            <button onclick="location.reload()" class="btn btn-light btn-sm text-muted"><i class="bi bi-arrow-clockwise"></i></button>
        </div>

        <div class="container px-3 pb-5">

            <div id="tab-input" class="page-section">
                <form id="consult-form">
                    <div class="card mb-3 border-0 shadow-sm bg-white">
                        <div class="card-body py-3">
                            <label class="fw-bold small text-muted text-uppercase mb-2">Specialty</label>
                            <div id="specialty-container"></div>
                        </div>
                    </div>

                    <div id="div-gi-diag" class="card mb-3 border-0 shadow-sm bg-white hidden">
                        <div class="card-body py-3 border-start border-4 border-warning">
                            <label class="fw-bold text-warning mb-2">GI Diagnosis</label>
                            <select id="gi-diagnosis" class="form-select">
                                <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Diagnosis --</option>
                                <option value="UGIB">UGIB</option>
                                <option value="Other GI bleed">Other GI bleed</option>
                                <option value="Non GI bleed">Non GI bleed</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted text-uppercase">Visit Type</label>
                        <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="visitType" id="v1" value="First visit" checked onchange="toggleMode()">
                            <label class="btn btn-outline-primary" for="v1">First Visit</label>
                            <input type="radio" class="btn-check" name="visitType" id="v2" value="Follow up visit" onchange="toggleMode()">
                            <label class="btn btn-outline-primary" for="v2">Follow Up</label>
                        </div>
                    </div>

                    <div id="mode-scan" class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">New Case (Photo)</label>
                        
                        <div class="d-flex gap-2">
                            <label class="btn btn-warning w-50 py-3 shadow-sm text-dark fw-bold position-relative">
                                <i class="bi bi-camera-fill fs-4 d-block"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                                <input type="file" id="camInput" accept="image/*" capture="environment" 
                                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"
                                       onchange="processFile(this)">
                            </label>
                            
                            <label class="btn btn-outline-secondary w-50 py-3 shadow-sm fw-bold position-relative">
                                <i class="bi bi-images fs-4 d-block"></i> ‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°
                                <input type="file" id="galInput" accept="image/*"
                                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"
                                       onchange="processFile(this)">
                            </label>
                        </div>
                        
                        <div class="form-text text-muted mt-2 small text-center">
                            * ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏õ‡∏∏‡πä‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </div>

                        <div class="text-center mt-2 position-relative">
                            <img id="preview" class="hidden shadow-sm border" style="max-width: 100%; border-radius: 8px;">
                        </div>
                        
                        <button type="button" id="btn-scan" class="btn btn-secondary w-100 mt-2 hidden" disabled>
                            ‡∏£‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...
                        </button>
                        
                        <button type="button" onclick="openExternal()" class="btn btn-outline-secondary w-100 mt-3 btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Browser
                        </button>
                    </div>

                    <div id="mode-search" class="mb-3 hidden position-relative">
                        <label class="form-label fw-bold small text-muted text-uppercase">Search Patient</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" id="patient-search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ HN..." onkeyup="filterPatients()">
                        </div>
                        <div id="search-results" class="search-results hidden"></div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-12">
                            <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="p-name" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ" required>
                        </div>
                        <div class="col-12">
                            <label class="small text-muted">HN</label>
                            <input type="text" id="p-hn" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç HN" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 btn-lg shadow fw-bold mb-5">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <i class="bi bi-save"></i></button>
                </form>
            </div>

            <div id="tab-history" class="page-section hidden">
                <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h5>
                <div class="btn-group w-100 mb-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(7)">7 ‡∏ß‡∏±‡∏ô</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(30)">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(90)">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                </div>
                <div id="history-list" class="list-group shadow-sm border-0"></div>
                <p id="no-history" class="text-center text-muted mt-5 hidden">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</p>
            </div>

            <div id="tab-dashboard" class="page-section hidden">
                <h5 class="fw-bold mb-3"><i class="bi bi-graph-up-arrow"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                <div class="card mb-3 border-0 shadow-sm bg-white">
                  <div class="card-body p-2">
                    <div class="row g-2">
                        <div class="col-6"><select id="filter-scope" class="form-select form-select-sm" onchange="updateDash()"><option value="me">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</option><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div>
                        <div class="col-6"><select id="filter-year" class="form-select form-select-sm" onchange="updateDash()"></select></div>
                        <div class="col-6 hidden" id="div-filter-doc"><select id="filter-doc" class="form-select form-select-sm" onchange="updateDash()"><option value="all">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option></select></div>
                        <div class="col-6"><select id="filter-spec" class="form-select form-select-sm" onchange="updateDash()"><option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option></select></div>
                    </div>
                  </div>
                </div>
                <div class="card bg-primary text-white mb-3 shadow border-0">
                    <div class="card-body text-center p-4">
                        <h6 class="mb-0 text-white-50">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
                        <h1 class="display-4 fw-bold mb-0" id="chart-total">0</h1>
                    </div>
                </div>
                <div class="card mb-3 border-0 shadow-sm"><div class="card-body"><canvas id="barChart" style="max-height: 250px;"></canvas></div></div>
            </div>

        </div> 
    </div> 

  </div>

  <div id="bottom-nav" class="bottom-nav hidden">
    <div class="nav-item active" id="nav-input" onclick="switchTab('input')"><i class="bi bi-pencil-square"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div class="nav-item" id="nav-history" onclick="switchTab('history')"><i class="bi bi-card-list"></i><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span></div>
    <div class="nav-item" id="nav-dashboard" onclick="switchTab('dashboard')"><i class="bi bi-pie-chart"></i><span>‡∏™‡∏£‡∏∏‡∏õ</span></div>
  </div>

  <script>
    // ************************************************
    // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ URL ‡πÅ‡∏•‡∏∞ LIFF ID
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz8P4vW1tS1mfGMys4VwTWVWaV89kJZs9V9DNX3vcb_MzjKjvsSDfmwh2wlg1tgFHeS/exec'; 
    const LIFF_ID = '2008753162-pqFRi41y'; 
    // ************************************************

    let currentDoctor = null;
    let existingPatients = [];
    let rawDashboardData = [];
    let allDoctors = [];
    let base64String = "";
    let barChart = null;
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tab ‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    let isHistoryLoaded = false;
    let isDashLoaded = false;

    // Register Plugin
    if(typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

    window.onload = async function() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        
        // üî• ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà 'loadApp' ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö
        initApp(profile.userId);
        
      } catch (err) { console.error(err); }
    };

    function initApp(uid) {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Server ‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        fetch(`${WEB_APP_URL}?action=loadApp&uid=${uid}`)
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                // ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                currentDoctor = res.doctor;
                existingPatients = res.patients; // ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                allDoctors = res.doctors; // ‡∏´‡∏°‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                
                startApp();
            } else {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('unauth-screen').classList.remove('hidden');
                document.getElementById('show-uid').innerText = res.uid;
            }
        }).catch(e => alert("Connection Error: "+e));
    }

    function startApp() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('unauth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.remove('hidden');
        
        document.getElementById('header-doc-name').innerText = currentDoctor.name;
        
        // Render Specialty
        const container = document.getElementById('specialty-container'); 
        container.innerHTML = "";
        currentDoctor.specialties.forEach((spec, i) => {
            const div = document.createElement('div');
            div.className = "form-check form-check-inline";
            const input = document.createElement('input');
            input.className = "form-check-input";
            input.type = "radio";
            input.name = "specialty";
            input.value = spec.trim();
            input.id = "spec-" + i;
            if (i === 0) input.checked = true;
            input.addEventListener('change', checkGI);
            const label = document.createElement('label');
            label.className = "form-check-label";
            label.htmlFor = "spec-" + i;
            label.innerText = spec.trim();
            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        });
        checkGI();

        // Init Dashboard Filters (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü)
        initDashFilters();
    }

    // --- Tab Switching (LAZY LOAD) ---
    window.switchTab = function(tab) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.getElementById('nav-' + tab).classList.add('active');
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Lazy Load)
        if(tab === 'history') {
             if(!isHistoryLoaded) { loadHistory(7); isHistoryLoaded = true; }
        }
        if(tab === 'dashboard') {
             if(!isDashLoaded) { loadDashboard(); isDashLoaded = true; }
             else updateDash(); // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏Ñ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï filter
        }
        
        window.scrollTo(0,0);
    }
    
    // --- Image Processing ---
    window.processFile = function(input) {
        const f = input.files[0];
        if (f) {
            const btnScan = document.getElementById('btn-scan');
            btnScan.classList.remove('hidden');
            btnScan.classList.remove('btn-success', 'btn-danger'); 
            btnScan.classList.add('btn-secondary');
            btnScan.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏£‡∏π‡∏õ...';
            btnScan.disabled = true;

            const r = new FileReader();
            r.onload = function(e) {
                const i = new Image();
                i.onload = function() {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d');
                    const maxW = 800; const scale = maxW / i.width;
                    c.width = maxW; c.height = i.height * scale;
                    ctx.drawImage(i, 0, 0, c.width, c.height);
                    base64String = c.toDataURL('image/jpeg', 0.7).split(',')[1];
                    document.getElementById('preview').src = c.toDataURL();
                    document.getElementById('preview').classList.remove('hidden');
                    scanImage();
                };
                i.src = e.target.result;
            };
            r.readAsDataURL(f);
        }
        input.value = '';
    }

    window.scanImage = function() { 
        const btn = document.getElementById('btn-scan'); 
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠...';
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-secondary');
        
        fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'analyze', image:base64String})})
        .then(r=>r.json()).then(res=>{ 
            document.getElementById('p-name').value = res.name || ""; 
            document.getElementById('p-hn').value = res.hn || ""; 
            btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            btn.disabled = false;
        }).catch(() => { 
            btn.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> AI ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-danger');
            btn.disabled = false;
        });
    }

    // --- Helpers ---
    window.checkGI = function() {
        const selected = document.querySelector('input[name="specialty"]:checked');
        const giDiv = document.getElementById('div-gi-diag');
        const giSelect = document.getElementById('gi-diagnosis');
        if (selected && selected.value.toUpperCase() === 'GI') {
            giDiv.classList.remove('hidden'); giSelect.required = true;
        } else {
            giDiv.classList.add('hidden'); giSelect.value = ""; giSelect.required = false;
        }
    }

    window.copyUID = function() { navigator.clipboard.writeText(document.getElementById('show-uid').innerText); alert("Copied"); }
    window.openExternal = function() { if (liff.isInClient()) { liff.openWindow({ url: window.location.href, external: true }); } else { alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"); } }

    window.toggleMode = function() {
        const type = document.querySelector('input[name="visitType"]:checked').value;
        if(type.includes('First')) { document.getElementById('mode-scan').classList.remove('hidden'); document.getElementById('mode-search').classList.add('hidden'); } 
        else { document.getElementById('mode-scan').classList.add('hidden'); document.getElementById('mode-search').classList.remove('hidden'); }
    }

    // --- Data Loaders (Search & List) ---
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ loadExistingPatients() ‡πÅ‡∏•‡∏∞ loadAllDoctors() ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å‡πÉ‡∏ô initApp

    window.filterPatients = function() {
        const q = document.getElementById('patient-search').value.toLowerCase();
        const box = document.getElementById('search-results'); box.innerHTML="";
        if(q.length < 2) { box.classList.add('hidden'); return; }
        const found = existingPatients.filter(p => p.name.toLowerCase().includes(q) || String(p.hn).includes(q));
        if(found.length > 0) {
            box.classList.remove('hidden');
            found.forEach(p => { box.innerHTML += `<div class="search-item" onclick="fillPatient('${p.name}', '${p.hn}')"><strong>${p.name}</strong> <span class="text-muted">(${p.hn})</span></div>`; });
        } else { box.classList.add('hidden'); }
    }
    window.fillPatient = function(n, h) { document.getElementById('p-name').value = n; document.getElementById('p-hn').value = h; document.getElementById('search-results').classList.add('hidden'); document.getElementById('patient-search').value = ""; }

    // --- History (‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Tab) ---
    window.loadHistory = function(days) {
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active','bg-secondary','text-white'));
        if(event) event.target.classList.add('active','bg-secondary','text-white');
        
        const list = document.getElementById('history-list'); 
        list.innerHTML = '<div class="text-center mt-4"><span class="spinner-border text-primary"></span><br><small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</small></div>';
        
        fetch(`${WEB_APP_URL}?action=getHistory&uid=${currentDoctor.uid}&days=${days}`).then(r=>r.json()).then(data => {
            list.innerHTML = "";
            if(data.length === 0) { document.getElementById('no-history').classList.remove('hidden'); }
            else {
                document.getElementById('no-history').classList.add('hidden');
                data.forEach(item => {
                    const sn = item.patient.replace(/'/g, "\\'"); const sh = item.hn.replace(/'/g, "\\'");
                    list.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center"><div><h6 class="mb-0 text-primary fw-bold">${item.patient}</h6><small class="text-muted">${item.date}</small></div><button class="btn btn-outline-primary btn-sm" onclick="selectHistory('${sn}','${sh}')">Follow</button></div>`;
                });
            }
        });
    }
    window.selectHistory = function(n, h) { switchTab('input'); document.getElementById('v2').click(); document.getElementById('p-name').value = n; document.getElementById('p-hn').value = h; }

    // --- Dashboard (‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Tab) ---
    function initDashFilters() {
        const docSelect = document.getElementById('filter-doc'); 
        if(docSelect) {
             docSelect.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>';
             if(allDoctors) allDoctors.forEach(d => { docSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`; });
        }
        const yearSelect = document.getElementById('filter-year'); const y = new Date().getFullYear();
        if(yearSelect) yearSelect.innerHTML = `<option value="${y}">${y}</option><option value="${y-1}">${y-1}</option>`;
    }
    
    function loadDashboard() { 
        // ‡πÇ‡∏ä‡∏ß‡πå Loading ‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡πà‡∏≠‡∏ô
        const ctx = document.getElementById('barChart');
        // ... (Optional: show loading UI) ...
        
        fetch(`${WEB_APP_URL}?action=getDashboardData&uid=${currentDoctor.uid}`).then(r=>r.json()).then(d=>{ 
            if(!d.error) {
                rawDashboardData=d; 
                updateDash();
            }
        }); 
    }
    
    window.updateDash = function() {
        const scope = document.getElementById('filter-scope').value; 
        const year = parseInt(document.getElementById('filter-year').value);
        const fDoc = document.getElementById('filter-doc').value; 
        const fSpec = document.getElementById('filter-spec').value;
        document.getElementById('div-filter-doc').classList.toggle('hidden', scope !== 'all');
        
        const filtered = rawDashboardData.filter(item => {
            const d = new Date(item.date);
            if (d.getFullYear() !== year) return false;
            if (scope === 'me' && item.doctor !== currentDoctor.name) return false;
            if (scope === 'all' && fDoc !== 'all' && item.doctor !== fDoc) return false;
            if (fSpec !== 'all' && item.specialty.trim() !== fSpec) return false;
            return true;
        });
        
        document.getElementById('chart-total').innerText = filtered.length;
        
        let firstVisitData = Array(12).fill(0);
        let followUpData = Array(12).fill(0);
        
        filtered.forEach(item => {
            const month = new Date(item.date).getMonth();
            if (item.type && item.type.toLowerCase().includes('first')) { firstVisitData[month]++; } 
            else { followUpData[month]++; }
        });
        
        const ctx1 = document.getElementById('barChart');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], 
                datasets: [
                    { label: 'First Visit', data: firstVisitData, backgroundColor: '#0d6efd', stack: 'Stack 0' },
                    { label: 'Follow Up', data: followUpData, backgroundColor: '#9ec5fe', stack: 'Stack 0' }
                ]
            },
            options: {
                responsive: true,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                plugins: {
                    datalabels: { color: 'white', font: { weight: 'bold' }, display: function(context) { return context.dataset.data[context.dataIndex] > 0; } },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    // Submit
    document.getElementById('consult-form').onsubmit = function(e) {
        e.preventDefault();
        document.getElementById('loading').classList.remove('hidden');
        let diagnosisVal = "";
        const giDiv = document.getElementById('div-gi-diag');
        if (!giDiv.classList.contains('hidden')) { diagnosisVal = document.getElementById('gi-diagnosis').value; }

        const payload = {
            doctorName: currentDoctor.name,
            specialty: document.querySelector('input[name="specialty"]:checked').value,
            patientName: document.getElementById('p-name').value,
            hn: document.getElementById('p-hn').value,
            visitType: document.querySelector('input[name="visitType"]:checked').value,
            diagnosis: diagnosisVal
        };
        fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'save', payload:payload})}).then(r=>r.json()).then(()=>{ alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ"); location.reload(); });
    };

  </script>
</body>
</html>

