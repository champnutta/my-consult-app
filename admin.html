<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        .card-stat { transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="p-3">

    <div class="container" style="max-width: 800px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold text-primary">‚öôÔ∏è Admin Dashboard</h4>
            <span id="admin-status" class="badge bg-secondary">Checking...</span>
        </div>

        <div id="error-box" class="alert alert-danger d-none"></div>

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white fw-bold">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Weights)</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                <th class="text-center">New Case</th>
                                <th class="text-center">F/U</th>
                                <th class="text-center">UGIB</th>
                            </tr>
                        </thead>
                        <tbody id="doctor-list">
                            <tr><td colspan="4" class="text-center py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-end">
                <button onclick="saveWeights()" id="btn-save" class="btn btn-success"><i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white fw-bold d-flex justify-content-between">
                <span>2. ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏° (Realtime)</span>
                <button onclick="loadStats()" class="btn btn-sm btn-outline-primary">Refresh</button>
            </div>
            <div class="card-body">
                <div class="row text-center" id="stats-box">
                   <div class="col-12 text-muted">‡∏Å‡∏î Refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• ‡πÅ‡∏Å‡πâ URL Cloud Run ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ú‡∏¥‡∏î)
        const API_URL = "https://smart-consult-api-890183822347.asia-southeast3.run.app"; 
        const LIFF_ID = "2008753162-pqFRi41y"; 

        let currentAdminUID = "";
        let doctorsData = [];

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentAdminUID = profile.userId;
                
                document.getElementById('admin-status').innerText = "UID: " + currentAdminUID.substring(0,5) + "...";
                loadAdminData();
            } catch (e) {
                showError("LIFF Error: " + e);
            }
        }

        async function loadAdminData() {
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API loadAdminApp
                const res = await fetch(`${API_URL}?action=loadAdminApp&uid=${currentAdminUID}`);
                const data = await res.json();

                if (data.error) {
                    showError("Access Denied: " + data.error);
                    return;
                }

                document.getElementById('admin-status').className = "badge bg-success";
                document.getElementById('admin-status').innerText = "Admin Access Granted";
                
                doctorsData = data.doctors || [];
                renderDoctorTable();
                loadStats(); // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢

            } catch (e) {
                showError("Network Error: " + e);
            }
        }

        function renderDoctorTable() {
            const tbody = document.getElementById('doctor-list');
            tbody.innerHTML = "";
            
            if (doctorsData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Users Collection ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)</td></tr>`;
                return;
            }

            doctorsData.forEach((d, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-primary">${d.name}</td>
                        <td><input type="number" step="0.1" class="form-control form-control-sm text-center" value="${d.w_first || 1}" id="w_first_${index}"></td>
                        <td><input type="number" step="0.1" class="form-control form-control-sm text-center" value="${d.w_follow || 1}" id="w_follow_${index}"></td>
                        <td><input type="number" step="0.1" class="form-control form-control-sm text-center" value="${d.w_ugib || 1}" id="w_ugib_${index}"></td>
                    </tr>
                `;
            });
        }

        async function saveWeights() {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Saving..."; btn.disabled = true;
            
            const payload = doctorsData.map((d, index) => ({
                docUID: d.uid, // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô users collection ‡∏°‡∏µ field uid ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢
                w_first: document.getElementById(`w_first_${index}`).value,
                w_follow: document.getElementById(`w_follow_${index}`).value,
                w_ugib: document.getElementById(`w_ugib_${index}`).value
            }));

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'updateWeights',
                        uid: currentAdminUID,
                        payload: payload
                    })
                });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch(e) { alert("Error: " + e); }
            finally { btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤"; btn.disabled = false; }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}`);
                const stats = await res.json();
                
                const box = document.getElementById('stats-box');
                box.innerHTML = "";
                
                if(stats.length === 0) {
                    box.innerHTML = `<div class="text-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Logs ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>`;
                    return;
                }

                stats.forEach(s => {
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
                    let totalScore = (s.c_first * s.w_first) + (s.c_follow * s.w_follow);
                    box.innerHTML += `
                        <div class="col-6 col-md-4 mb-3">
                            <div class="card p-3 h-100 shadow-sm border-0 bg-light">
                                <h6 class="fw-bold">${s.name}</h6>
                                <div class="display-6 text-primary fw-bold">${totalScore.toFixed(1)}</div>
                                <small class="text-muted">New: ${s.c_first} | FU: ${s.c_follow}</small>
                            </div>
                        </div>
                    `;
                });

            } catch(e) { console.error(e); }
        }

        function showError(msg) {
            const box = document.getElementById('error-box');
            box.classList.remove('d-none');
            box.innerText = msg;
        }

        main();
    </script>
</body>
</html>
