<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        .filter-box { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
        .input-weight { width: 60px; text-align: center; border: 1px solid #dee2e6; border-radius: 4px; padding: 2px; }
        .input-weight:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .hidden-row { display: none !important; }
    </style>
</head>
<body class="p-3">
    <div class="container" style="max-width: 1200px;">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary"><i class="bi bi-shield-lock"></i> Admin System</h4>
            <span id="admin-badge" class="badge bg-secondary">Checking...</span>
        </div>

        <div class="filter-box mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Global)</label>
                    <select id="filter-mode" class="form-select form-select-sm" onchange="renderFilterInputs()">
                        <option value="fiscal_year" selected>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="quarter">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option>
                        <option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div id="filter-inputs" class="row g-2"></div>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å (Table Only)</label>
                    <select id="filter-dept" class="form-select form-select-sm" onchange="applyDepartmentFilter()">
                        <option value="All" selected>‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <button onclick="loadStats()" class="btn btn-primary btn-sm w-100 fw-bold">
                        <i class="bi bi-arrow-repeat"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
            <div class="mt-2 small text-muted text-end" id="date-range-display">Loading...</div>
        </div>

        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="gen-tab" data-bs-toggle="tab" data-bs-target="#gen-pane" type="button">üìä General PA</button></li>
            <li class="nav-item"><button class="nav-link" id="gi-tab-btn" data-bs-toggle="tab" data-bs-target="#gi-pane" type="button">ü©∏ GI Statistics</button></li>
            <li class="nav-item"><button class="nav-link" id="act-tab-btn" data-bs-toggle="tab" data-bs-target="#act-pane" type="button">üìù Activity Report</button></li>
            <li class="nav-item"><button class="nav-link" id="trend-tab-btn" data-bs-toggle="tab" data-bs-target="#trend-pane" type="button" onclick="loadCompetitiveGraph()">üìà Trends</button></li>
            <li class="nav-item"><button class="nav-link text-dark" id="user-tab-btn" data-bs-toggle="tab" data-bs-target="#user-pane" type="button"><i class="bi bi-person-plus-fill"></i> Users</button></li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            
            <div class="tab-pane fade show active" id="gen-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0"><thead class="table-light text-center"><tr><th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>New</th><th>F/U</th><th>Wt.New</th><th>Wt.F/U</th><th>Score</th></tr></thead><tbody id="tbody-gen"></tbody></table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end"><button onclick="saveWeights()" class="btn btn-success btn-sm fw-bold">Save Weights</button></div>
                </div>
            </div>

            <div class="tab-pane fade" id="gi-pane" role="tabpanel">
                <div class="card border-0 shadow-sm"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light text-center"><tr><th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå (GI)</th><th class="text-danger">UGIB</th><th>Other</th><th>Non</th><th class="fw-bold text-danger">GI Score</th></tr></thead><tbody id="tbody-gi"></tbody></table></div></div></div>
            </div>

            <div class="tab-pane fade" id="act-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="actView" id="view-summary" value="summary" checked onchange="renderActivityTab()">
                                    <label class="btn btn-outline-primary btn-sm" for="view-summary">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</label>
                                    <input type="radio" class="btn-check" name="actView" id="view-detail" value="detail" onchange="renderActivityTab()">
                                    <label class="btn btn-outline-primary btn-sm" for="view-detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                </div>
                            </div>
                            <div class="col-md-3"><select id="act-filter-doc" class="form-select form-select-sm" onchange="renderActivityTab()"><option value="All">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option></select></div>
                            <div class="col-md-3 text-end align-self-end"><span class="badge bg-info text-dark fs-6" id="act-total-badge">...</span></div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="tbl-act-summary" class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th class="ps-4">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th><th class="text-end pe-4">Action</th></tr></thead><tbody id="tbody-act-summary"></tbody></table>
                            <table id="tbl-act-detail" class="table table-hover align-middle mb-0 d-none"><thead class="table-light"><tr><th class="ps-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th><th>‡πÅ‡∏û‡∏ó‡∏¢‡πå</th><th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th></tr></thead><tbody id="tbody-act-detail"></tbody></table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small text-end">
                        * ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏ô‡∏±‡∏ö 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏ß‡∏±‡∏ô)
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="trend-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between">
                        <span><i class="bi bi-graph-up-arrow"></i> Competitive Graph (Rolling 12 Months)</span>
                        <button onclick="loadCompetitiveGraph()" class="btn btn-sm btn-outline-secondary">Refresh</button>
                    </div>
                    <div class="card-body"><div style="height: 400px;"><canvas id="compChart"></canvas></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="user-pane" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 mb-3">
                            <div class="card-header bg-white fw-bold text-success"><i class="bi bi-person-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà</div>
                            <div class="card-body">
                                <form id="form-add-user">
                                    <div class="mb-2">
                                        <label class="small text-muted">User UID</label>
                                        <input type="text" id="new-uid" class="form-control form-control-sm" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                                        <input type="text" id="new-name" class="form-control form-control-sm" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="small text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                        <input type="text" id="new-spec" class="form-control form-control-sm" placeholder="Ex. GI, IM" required>
                                    </div>
                                    <button type="submit" class="btn btn-success btn-sm w-100 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white fw-bold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 500px;">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-3">‡∏ä‡∏∑‡πà‡∏≠</th>
                                                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                                <th>UID (‡∏¢‡πà‡∏≠)</th>
                                                <th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-users"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "https://smart-consult-api-890183822347.asia-southeast3.run.app"; 
        const LIFF_ID = "2008753162-pqFRi41y"; 

        let currentAdminUID = "";
        let doctorsData = [];
        let currentStats = []; 
        let currentActivities = []; 
        let compChart = null;

        window.onload = async function() {
            renderFilterInputs();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentAdminUID = (await liff.getProfile()).userId;
                document.getElementById('admin-badge').innerText = "Admin Ready";
                document.getElementById('admin-badge').className = "badge bg-success";
                loadConfigAndStats();
            } catch(e) { alert("LIFF Error: " + e); }
        }

        function renderFilterInputs() {
            const mode = document.getElementById('filter-mode').value;
            const container = document.getElementById('filter-inputs');
            const curY = new Date().getFullYear();
            let html = '';
            
            if(mode === 'fiscal_year') { html = `<select id="inp-year" class="form-select form-select-sm w-100"><option value="${curY+1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY+1}</option><option value="${curY}" selected>‡∏õ‡∏µ‡∏á‡∏ö ${curY}</option><option value="${curY-1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY-1}</option></select>`; }
            else if (mode === 'quarter') { html = `<div class="d-flex gap-2"><select id="inp-year" class="form-select form-select-sm"><option value="${curY}">${curY}</option><option value="${curY-1}">${curY-1}</option></select><select id="inp-q" class="form-select form-select-sm"><option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4" selected>Q4</option></select></div>`; }
            else if (mode === 'month') { html = `<div class="d-flex gap-2"><select id="inp-year" class="form-select form-select-sm"><option value="${curY}" selected>${curY}</option></select><select id="inp-month" class="form-select form-select-sm"><option value="1">‡∏°.‡∏Ñ.</option><option value="2">‡∏Å.‡∏û.</option><option value="3">‡∏°‡∏µ.‡∏Ñ.</option><option value="4">‡πÄ‡∏°.‡∏¢.</option><option value="5">‡∏û.‡∏Ñ.</option><option value="6">‡∏°‡∏¥.‡∏¢.</option><option value="7">‡∏Å.‡∏Ñ.</option><option value="8">‡∏™.‡∏Ñ.</option><option value="9">‡∏Å.‡∏¢.</option><option value="10">‡∏ï.‡∏Ñ.</option><option value="11">‡∏û.‡∏¢.</option><option value="12">‡∏ò.‡∏Ñ.</option></select></div>`; }
            else { html = `<div class="d-flex gap-2"><input type="date" id="inp-start" class="form-control form-control-sm"><input type="date" id="inp-end" class="form-control form-control-sm"></div>`; }
            container.innerHTML = html;
        }

        function getFilterDates() {
            const mode = document.getElementById('filter-mode').value;
            let start = "", end = "";
            const y = document.getElementById('inp-year') ? parseInt(document.getElementById('inp-year').value) : new Date().getFullYear();

            if(mode === 'fiscal_year') { start = `${y-1}-10-01`; end = `${y}-10-01`; } 
            else if(mode === 'quarter') {
                const q = document.getElementById('inp-q').value;
                if(q == '1') { start = `${y-1}-10-01`; end = `${y-1}-12-31`; }
                else if(q == '2') { start = `${y}-01-01`; end = `${y}-04-01`; }
                else if(q == '3') { start = `${y}-04-01`; end = `${y}-07-01`; }
                else { start = `${y}-07-01`; end = `${y}-10-01`; }
            }
            else if(mode === 'month') {
                const m = parseInt(document.getElementById('inp-month').value);
                start = `${y}-${String(m).padStart(2,'0')}-01`;
                const nextM = m === 12 ? 1 : m + 1;
                const nextY = m === 12 ? y + 1 : y;
                end = `${nextY}-${String(nextM).padStart(2,'0')}-01`;
            } else {
                start = document.getElementById('inp-start').value;
                end = document.getElementById('inp-end').value;
            }
            return { s: start + "T00:00:00", e: end + "T23:59:59" };
        }

        async function loadConfigAndStats() {
            const resConf = await fetch(`${API_URL}?action=loadAdminApp&uid=${currentAdminUID}`);
            const dataConf = await resConf.json();
            if(dataConf.error) { alert("Access Denied"); return; }
            doctorsData = dataConf.doctors || [];
            
            // Sort Doctors
            doctorsData.sort((a, b) => {
                const specA = (a.specialties && a.specialties.length > 0) ? a.specialties[0].toString() : 'zzz';
                const specB = (b.specialties && b.specialties.length > 0) ? b.specialties[0].toString() : 'zzz';
                return specA.localeCompare(specB) || a.name.localeCompare(b.name);
            });

            // Filters
            const deptSet = new Set();
            const docSel = document.getElementById('act-filter-doc');
            docSel.innerHTML = '<option value="All">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>';
            document.getElementById('filter-dept').innerHTML = '<option value="All">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';

            doctorsData.forEach(d => {
                if(d.specialties) d.specialties.forEach(s => deptSet.add(s));
                docSel.innerHTML += `<option value="${d.name}">${d.name}</option>`;
            });
            Array.from(deptSet).sort().forEach(s => document.getElementById('filter-dept').innerHTML += `<option value="${s}">${s}</option>`);

            loadStats();
            renderUserTable(); 
        }

        async function loadStats() {
            const range = getFilterDates();
            document.getElementById('date-range-display').innerText = `${range.s.split('T')[0]} - ${range.e.split('T')[0]}`;
            
            const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}&start=${range.s}&end=${range.e}`);
            const result = await res.json();
            
            currentStats = result.table || [];
            currentActivities = result.activities || [];

            renderGeneralTabs(); 
            renderActivityTab();
        }

        function renderGeneralTabs() {
            const tbodyGen = document.getElementById('tbody-gen');
            const tbodyGI = document.getElementById('tbody-gi');
            tbodyGen.innerHTML = ""; tbodyGI.innerHTML = "";

            doctorsData.forEach((doc, idx) => {
                const s = currentStats.find(x => x.name === doc.name) || { c_first:0, c_follow:0, c_ugib:0, c_other:0, c_non:0 };
                const scoreGen = (s.c_first * doc.w_first) + (s.c_follow * doc.w_follow);
                const scoreGI = (s.c_ugib * doc.w_ugib) + (s.c_other * doc.w_other) + (s.c_non * doc.w_non);
                const specDisplay = doc.specialties ? doc.specialties.join(", ") : "-";
                const deptAttr = doc.specialties ? doc.specialties.join(",") : "";

                tbodyGen.innerHTML += `<tr data-dept="${deptAttr}"><td class="text-start ps-4 fw-bold text-dark">${doc.name}</td><td><span class="badge bg-light text-dark border">${specDisplay}</span></td><td class="text-center">${s.c_first}</td><td class="text-center">${s.c_follow}</td><td class="text-center"><input type="number" step="0.1" class="input-weight" value="${doc.w_first}" onchange="updW(${idx}, 'w_first', this.value)"></td><td class="text-center"><input type="number" step="0.1" class="input-weight" value="${doc.w_follow}" onchange="updW(${idx}, 'w_follow', this.value)"></td><td class="text-center fw-bold text-primary">${scoreGen.toFixed(1)}</td></tr>`;

                const isGI = (doc.specialties||[]).some(s => s.toLowerCase().includes('gi') || s.toLowerCase().includes('gastro')) || s.c_ugib > 0;
                if(isGI) tbodyGI.innerHTML += `<tr><td class="text-start ps-4 fw-bold text-dark">${doc.name}</td><td class="text-center text-danger bg-light">${s.c_ugib}</td><td class="text-center">${s.c_other}</td><td class="text-center">${s.c_non}</td><td class="text-center fw-bold text-danger">${scoreGI.toFixed(1)}</td></tr>`;
            });
            applyDepartmentFilter();
        }

        function applyDepartmentFilter() {
            const selectedDept = document.getElementById('filter-dept').value;
            document.querySelectorAll('#tbody-gen tr').forEach(row => {
                const depts = row.getAttribute('data-dept');
                if (selectedDept === 'All' || depts.includes(selectedDept)) row.classList.remove('hidden-row');
                else row.classList.add('hidden-row');
            });
        }

        // üî• MODIFIED: Activity Tab with Deduplication
        function renderActivityTab() {
            const viewMode = document.querySelector('input[name="actView"]:checked').value;
            const fDoc = document.getElementById('act-filter-doc').value;
            
            // 1. First Filter by Doctor
            let rawFiltered = currentActivities.filter(act => fDoc === 'All' || act.doctor === fDoc);

            // 2. Deduplication Logic (Same Doctor + Same Activity + Same Date)
            const uniqueKeys = new Set();
            const uniqueActivities = [];

            rawFiltered.forEach(act => {
                const dateKey = act.date.split('T')[0]; // YYYY-MM-DD
                const key = `${act.doctor}|${act.activity}|${dateKey}`;
                if(!uniqueKeys.has(key)) {
                    uniqueKeys.add(key);
                    uniqueActivities.push(act);
                }
            });

            // Use 'uniqueActivities' for display
            document.getElementById('act-total-badge').innerText = `${uniqueActivities.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            const tblSummary = document.getElementById('tbl-act-summary');
            const tblDetail = document.getElementById('tbl-act-detail');
            const tbodySum = document.getElementById('tbody-act-summary');
            const tbodyDet = document.getElementById('tbody-act-detail');
            tbodySum.innerHTML = ""; tbodyDet.innerHTML = "";

            if (viewMode === 'summary') {
                tblSummary.classList.remove('d-none'); tblDetail.classList.add('d-none');
                const grouped = {};
                uniqueActivities.forEach(act => {
                    if(!grouped[act.doctor]) grouped[act.doctor] = { count: 0, name: act.doctor };
                    grouped[act.doctor].count++;
                });
                Object.values(grouped).sort((a,b)=>b.count - a.count).forEach(g => {
                    const docInfo = doctorsData.find(d => d.name === g.name);
                    const specs = docInfo ? (docInfo.specialties || []).join(", ") : "-";
                    tbodySum.innerHTML += `<tr><td class="ps-4 fw-bold text-primary">${g.name}</td><td><span class="badge bg-light text-dark border">${specs}</span></td><td class="text-center fw-bold fs-5">${g.count}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-secondary" onclick="viewDoctorDetail('${g.name}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td></tr>`;
                });
            } else {
                tblSummary.classList.add('d-none'); tblDetail.classList.remove('d-none');
                uniqueActivities.sort((a,b) => new Date(b.date) - new Date(a.date));
                uniqueActivities.forEach(act => {
                    tbodyDet.innerHTML += `<tr><td class="ps-4 text-muted">${act.date.split('T')[0]}</td><td class="fw-bold">${act.activity}</td><td>${act.doctor}</td><td><span class="badge bg-secondary">${act.role}</span></td></tr>`;
                });
            }
        }

        async function loadCompetitiveGraph() {
            const today = new Date();
            const lastYear = new Date(); lastYear.setFullYear(today.getFullYear() - 1);
            const s = lastYear.toISOString().split('T')[0] + "T00:00:00";
            const e = today.toISOString().split('T')[0] + "T23:59:59";
            const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}&start=${s}&end=${e}`);
            const result = await res.json();
            renderGraph(result.graph || {});
        }

        function renderGraph(data) {
            const ctx = document.getElementById('compChart');
            const labels = Object.keys(data).sort();
            const specialties = new Set();
            Object.values(data).forEach(m => Object.keys(m).forEach(s => specialties.add(s)));
            const specsArray = Array.from(specialties);
            const datasets = specsArray.map((spec, i) => {
                const vals = labels.map(lbl => data[lbl][spec] || 0);
                const color = `hsl(${(i * 360) / specsArray.length}, 70%, 50%)`;
                return { label: spec, data: vals, borderColor: color, backgroundColor: color, tension: 0.3, fill: false };
            });
            if(compChart) compChart.destroy();
            compChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { itemSort: function(a, b) { return b.parsed.y - a.parsed.y; } } } } });
        }

        function renderUserTable() {
            const tbody = document.getElementById('tbody-users');
            tbody.innerHTML = "";
            doctorsData.forEach(d => {
                const specs = d.specialties ? d.specialties.join(", ") : "-";
                tbody.innerHTML += `<tr><td class="ps-3 fw-bold">${d.name}</td><td><span class="badge bg-light text-dark border">${specs}</span></td><td class="text-muted small font-monospace">${d.uid.substring(0,5)}...</td><td class="text-end pe-3"><button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${d.uid}', '${d.name}')"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        }

        document.getElementById('form-add-user').onsubmit = async function(e) {
            e.preventDefault();
            const uid = document.getElementById('new-uid').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const specStr = document.getElementById('new-spec').value.trim();
            const specialties = specStr.split(',').map(s => s.trim()).filter(s => s); 
            if(!uid || !name || specialties.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
            const btn = this.querySelector('button'); btn.innerText="Saving..."; btn.disabled=true;
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'manageUser', uid: currentAdminUID, sub_task: 'add', payload: { uid, name, specialties } }) });
                alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                this.reset(); loadConfigAndStats();
            } catch(e) { alert("Error: "+e); } finally { btn.innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled=false; }
        }

        async function deleteUser(targetUID, name) {
            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?`)) return;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'manageUser', uid: currentAdminUID, sub_task: 'delete', payload: { uid: targetUID } }) });
            alert("üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); loadConfigAndStats();
        }

        window.viewDoctorDetail = function(docName) { document.getElementById('act-filter-doc').value = docName; document.getElementById('view-detail').click(); }
        function updW(idx, field, val) { doctorsData[idx][field] = parseFloat(val); }
        async function saveWeights() {
            const payload = doctorsData.map(d => ({ docUID: d.uid, w_first: d.w_first, w_follow: d.w_follow, w_ugib: d.w_ugib, w_other: d.w_other, w_non: d.w_non }));
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateWeights', uid: currentAdminUID, payload: payload }) });
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadStats();
        }
    </script>
</body>
</html>
