<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        .filter-box { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="p-3">
    <div class="container" style="max-width: 1000px;">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary"><i class="bi bi-shield-lock"></i> Admin Dashboard</h4>
            <span id="admin-badge" class="badge bg-secondary">Checking Auth...</span>
        </div>

        <div class="filter-box mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                    <select id="filter-mode" class="form-select form-select-sm" onchange="renderFilterInputs()">
                        <option value="fiscal_year" selected>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ï.‡∏Ñ. - ‡∏Å.‡∏¢.)</option>
                        <option value="quarter">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ (Quarter)</option>
                        <option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (Custom)</option>
                    </select>
                </div>

                <div class="col-md-7">
                    <div id="filter-inputs" class="row g-2"></div>
                </div>

                <div class="col-md-2 text-end">
                    <button onclick="loadStats()" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-search"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
            <div class="mt-2 small text-muted text-end" id="date-range-display"></div>
        </div>

        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="gen-tab" data-bs-toggle="tab" data-bs-target="#gen-pane" type="button">üìä General PA</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gi-tab-btn" data-bs-toggle="tab" data-bs-target="#gi-pane" type="button">ü©∏ GI Statistics</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            
            <div class="tab-pane fade show active" id="gen-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                        <th>New Case</th>
                                        <th>F/U</th>
                                        <th style="width: 80px;" class="small text-muted">Wt. New</th>
                                        <th style="width: 80px;" class="small text-muted">Wt. F/U</th>
                                        <th class="fw-bold text-primary">Total Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gen"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <button onclick="saveWeights()" class="btn btn-success btn-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ Weight</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="gi-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå (GI Only)</th>
                                        <th class="text-danger">UGIB</th>
                                        <th>Other GIB</th>
                                        <th>Non GIB</th>
                                        <th class="fw-bold text-danger">GI Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gi"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <small class="text-muted">* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå GI ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ GI</small>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // üî• ‡πÅ‡∏Å‡πâ URL Cloud Run ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô
        const API_URL = "https://smart-consult-api-890183822347.asia-southeast3.run.app"; 
        const LIFF_ID = "2008753162-pqFRi41y"; 

        let currentAdminUID = "";
        let doctorsData = [];

        window.onload = async function() {
            renderFilterInputs(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á input filter ‡∏ï‡∏≤‡∏° default
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentAdminUID = (await liff.getProfile()).userId;
                
                document.getElementById('admin-badge').innerText = "Admin Logged In";
                document.getElementById('admin-badge').className = "badge bg-success";

                // ‡πÇ‡∏´‡∏•‡∏î 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á
                loadConfigAndStats();

            } catch(e) { alert("LIFF Error: " + e); }
        }

        // ================= FILTER LOGIC =================
        function renderFilterInputs() {
            const mode = document.getElementById('filter-mode').value;
            const container = document.getElementById('filter-inputs');
            const curY = new Date().getFullYear();
            
            let html = '';
            
            if(mode === 'fiscal_year') {
                html = `
                    <div class="col-12">
                        <label class="small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="inp-year" class="form-select form-select-sm">
                            <option value="${curY+1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY+1} (‡∏ï.‡∏Ñ. ${curY} - ‡∏Å.‡∏¢. ${curY+1})</option>
                            <option value="${curY}" selected>‡∏õ‡∏µ‡∏á‡∏ö ${curY} (‡∏ï.‡∏Ñ. ${curY-1} - ‡∏Å.‡∏¢. ${curY})</option>
                            <option value="${curY-1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY-1} (‡∏ï.‡∏Ñ. ${curY-2} - ‡∏Å.‡∏¢. ${curY-1})</option>
                        </select>
                    </div>`;
            } else if (mode === 'quarter') {
                html = `
                    <div class="col-6">
                        <label class="small text-muted">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="inp-year" class="form-select form-select-sm">
                            <option value="${curY}">${curY}</option>
                            <option value="${curY-1}">${curY-1}</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</label>
                        <select id="inp-q" class="form-select form-select-sm">
                            <option value="1">Q1 (‡∏ï.‡∏Ñ.-‡∏ò.‡∏Ñ.)</option>
                            <option value="2">Q2 (‡∏°.‡∏Ñ.-‡∏°‡∏µ.‡∏Ñ.)</option>
                            <option value="3">Q3 (‡πÄ‡∏°.‡∏¢.-‡∏°‡∏¥.‡∏¢.)</option>
                            <option value="4" selected>Q4 (‡∏Å.‡∏Ñ.-‡∏Å.‡∏¢.)</option>
                        </select>
                    </div>`;
            } else if (mode === 'month') {
                html = `
                    <div class="col-6">
                        <label class="small text-muted">‡∏õ‡∏µ ‡∏û.‡∏®.</label>
                        <select id="inp-year" class="form-select form-select-sm">
                            <option value="${curY}" selected>${curY}</option>
                            <option value="${curY-1}">${curY-1}</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="inp-month" class="form-select form-select-sm">
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>`;
            } else {
                html = `
                    <div class="col-6">
                        <label class="small text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="inp-start" class="form-control form-control-sm">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="inp-end" class="form-control form-control-sm">
                    </div>`;
            }
            container.innerHTML = html;
        }

        function getFilterDates() {
            const mode = document.getElementById('filter-mode').value;
            let start = "", end = "";
            
            if(mode === 'fiscal_year') {
                const y = parseInt(document.getElementById('inp-year').value);
                start = `${y-1}-10-01`; end = `${y}-10-01`;
            } 
            else if(mode === 'quarter') {
                const y = parseInt(document.getElementById('inp-year').value); // ‡∏õ‡∏µ‡∏á‡∏ö
                const q = document.getElementById('inp-q').value;
                // FY2026 -> Q1=Oct25, Q2=Jan26, Q3=Apr26, Q4=Jul26
                if(q == '1') { start = `${y-1}-10-01`; end = `${y-1}-12-31`; } // ‡∏´‡∏£‡∏∑‡∏≠ 01-01
                else if(q == '2') { start = `${y}-01-01`; end = `${y}-04-01`; }
                else if(q == '3') { start = `${y}-04-01`; end = `${y}-07-01`; }
                else { start = `${y}-07-01`; end = `${y}-10-01`; }
            }
            else if(mode === 'month') {
                const y = parseInt(document.getElementById('inp-year').value);
                const m = parseInt(document.getElementById('inp-month').value);
                start = `${y}-${String(m).padStart(2,'0')}-01`;
                // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà)
                const nextM = m === 12 ? 1 : m + 1;
                const nextY = m === 12 ? y + 1 : y;
                end = `${nextY}-${String(nextM).padStart(2,'0')}-01`;
            }
            else {
                start = document.getElementById('inp-start').value;
                end = document.getElementById('inp-end').value;
            }
            
            // Append Time
            return { s: start + "T00:00:00", e: end + "T23:59:59" };
        }

        // ================= DATA LOADING =================
        async function loadConfigAndStats() {
            const resConf = await fetch(`${API_URL}?action=loadAdminApp&uid=${currentAdminUID}`);
            const dataConf = await resConf.json();
            if(dataConf.error) { alert("Access Denied"); return; }
            doctorsData = dataConf.doctors || [];
            
            loadStats();
        }

        async function loadStats() {
            const range = getFilterDates();
            document.getElementById('date-range-display').innerText = `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${range.s.split('T')[0]} ‡∏ñ‡∏∂‡∏á ${range.e.split('T')[0]}`;
            
            const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}&start=${range.s}&end=${range.e}`);
            const stats = await res.json();
            
            renderTables(stats);
        }

        function renderTables(stats) {
            const tbodyGen = document.getElementById('tbody-gen');
            const tbodyGI = document.getElementById('tbody-gi');
            tbodyGen.innerHTML = ""; tbodyGI.innerHTML = "";

            doctorsData.forEach((doc, idx) => {
                const s = stats.find(x => x.name === doc.name) || { c_first:0, c_follow:0, c_ugib:0, c_other:0, c_non:0 };
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Score
                const scoreGen = (s.c_first * doc.w_first) + (s.c_follow * doc.w_follow);
                const scoreGI = (s.c_ugib * doc.w_ugib) + (s.c_other * doc.w_other) + (s.c_non * doc.w_non);

                // Render General Row
                tbodyGen.innerHTML += `
                    <tr data-uid="${doc.uid}">
                        <td class="text-start ps-4 fw-bold text-dark">${doc.name}</td>
                        <td class="text-center">${s.c_first}</td>
                        <td class="text-center">${s.c_follow}</td>
                        <td class="text-center"><input type="number" step="0.1" class="form-control form-control-sm text-center mx-auto" style="width:60px" value="${doc.w_first}" onchange="updateLocalWeight(${idx}, 'w_first', this.value)"></td>
                        <td class="text-center"><input type="number" step="0.1" class="form-control form-control-sm text-center mx-auto" style="width:60px" value="${doc.w_follow}" onchange="updateLocalWeight(${idx}, 'w_follow', this.value)"></td>
                        <td class="text-center fw-bold text-primary">${scoreGen.toFixed(1)}</td>
                    </tr>
                `;

                // Render GI Row (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏≠ GI)
                const specs = (doc.specialties || "").toString().toLowerCase();
                const isGI = specs.includes('gi') || specs.includes('gastro') || s.c_ugib > 0;
                
                if (isGI) {
                    tbodyGI.innerHTML += `
                        <tr data-uid="${doc.uid}">
                            <td class="text-start ps-4 fw-bold text-dark">${doc.name}</td>
                            <td class="text-center text-danger bg-light">${s.c_ugib}</td>
                            <td class="text-center">${s.c_other}</td>
                            <td class="text-center">${s.c_non}</td>
                            <td class="text-center fw-bold text-danger">${scoreGI.toFixed(1)}</td>
                        </tr>
                    `;
                }
            });
        }

        function updateLocalWeight(idx, field, val) {
            doctorsData[idx][field] = parseFloat(val);
        }

        async function saveWeights() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡∏à‡∏≤‡∏Å doctorsData ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
            const payload = doctorsData.map(d => ({
                docUID: d.uid,
                w_first: d.w_first, w_follow: d.w_follow,
                w_ugib: d.w_ugib, w_other: d.w_other, w_non: d.w_non
            }));

            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateWeights', uid: currentAdminUID, payload: payload })
            });
            const result = await res.json();
            
            if(result.status === 'success') {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Weight ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                loadStats(); // Reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà
            } else {
                alert("Error: " + JSON.stringify(result));
            }
        }
    </script>
</body>
</html>
