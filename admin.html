<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        .filter-box { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="p-3">
    <div class="container" style="max-width: 1000px;">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary"><i class="bi bi-shield-lock"></i> Admin Dashboard</h4>
            <span id="admin-badge" class="badge bg-secondary">Checking Auth...</span>
        </div>

        <div class="filter-box mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <select id="filter-mode" class="form-select form-select-sm" onchange="renderFilterInputs()">
                        <option value="fiscal_year" selected>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="quarter">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option>
                        <option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <div id="filter-inputs" class="row g-2"></div>
                </div>

                <div class="col-md-3">
                    <label class="small text-muted fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å (Department)</label>
                    <select id="filter-dept" class="form-select form-select-sm" onchange="applyLocalFilter()">
                        <option value="All" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                    </select>
                </div>

                <div class="col-md-2 text-end">
                    <button onclick="loadStats()" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-search"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
            <div class="mt-2 small text-muted text-end" id="date-range-display"></div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white fw-bold">
                <i class="bi bi-graph-up"></i> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å (Competitive View)
            </div>
            <div class="card-body">
                <canvas id="compChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="gen-tab" data-bs-toggle="tab" data-bs-target="#gen-pane" type="button">üìä General PA</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gi-tab-btn" data-bs-toggle="tab" data-bs-target="#gi-pane" type="button">ü©∏ GI Statistics</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            
            <div class="tab-pane fade show active" id="gen-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                        <th>New Case</th>
                                        <th>F/U</th>
                                        <th style="width: 80px;" class="small text-muted">Wt. New</th>
                                        <th style="width: 80px;" class="small text-muted">Wt. F/U</th>
                                        <th class="fw-bold text-primary">Total Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gen"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <button onclick="saveWeights()" class="btn btn-success btn-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ Weight</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="gi-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå (GI Only)</th>
                                        <th class="text-danger">UGIB</th>
                                        <th>Other GIB</th>
                                        <th>Non GIB</th>
                                        <th class="fw-bold text-danger">GI Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gi"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <small class="text-muted">* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå GI ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ GI</small>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // üî• URL Cloud Run ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô
        const API_URL = "https://smart-consult-api-890183822347.asia-southeast3.run.app"; 
        const LIFF_ID = "2008753162-pqFRi41y"; 

        let currentAdminUID = "";
        let doctorsData = [];
        let currentStats = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Filter Frontend
        let currentGraphData = {}; 
        let compChart = null;

        window.onload = async function() {
            renderFilterInputs();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentAdminUID = (await liff.getProfile()).userId;
                
                document.getElementById('admin-badge').innerText = "Admin Logged In";
                document.getElementById('admin-badge').className = "badge bg-success";

                loadConfigAndStats();

            } catch(e) { alert("LIFF Error: " + e); }
        }

        // ================= FILTER UI LOGIC =================
        function renderFilterInputs() {
            const mode = document.getElementById('filter-mode').value;
            const container = document.getElementById('filter-inputs');
            const curY = new Date().getFullYear();
            
            let html = '';
            if(mode === 'fiscal_year') {
                html = `<select id="inp-year" class="form-select form-select-sm w-100">
                            <option value="${curY+1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY+1}</option>
                            <option value="${curY}" selected>‡∏õ‡∏µ‡∏á‡∏ö ${curY}</option>
                            <option value="${curY-1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY-1}</option>
                        </select>`;
            } else if (mode === 'quarter') {
                html = `<div class="d-flex gap-2">
                            <select id="inp-year" class="form-select form-select-sm"><option value="${curY}">${curY}</option><option value="${curY-1}">${curY-1}</option></select>
                            <select id="inp-q" class="form-select form-select-sm">
                                <option value="1">Q1 (‡∏ï.‡∏Ñ.-‡∏ò.‡∏Ñ.)</option><option value="2">Q2 (‡∏°.‡∏Ñ.-‡∏°‡∏µ.‡∏Ñ.)</option><option value="3">Q3 (‡πÄ‡∏°.‡∏¢.-‡∏°‡∏¥.‡∏¢.)</option><option value="4" selected>Q4 (‡∏Å.‡∏Ñ.-‡∏Å.‡∏¢.)</option>
                            </select>
                        </div>`;
            } else if (mode === 'month') {
                html = `<div class="d-flex gap-2">
                            <select id="inp-year" class="form-select form-select-sm"><option value="${curY}" selected>${curY}</option></select>
                            <select id="inp-month" class="form-select form-select-sm">
                                <option value="1">‡∏°.‡∏Ñ.</option><option value="2">‡∏Å.‡∏û.</option><option value="3">‡∏°‡∏µ.‡∏Ñ.</option><option value="4">‡πÄ‡∏°.‡∏¢.</option>
                                <option value="5">‡∏û.‡∏Ñ.</option><option value="6">‡∏°‡∏¥.‡∏¢.</option><option value="7">‡∏Å.‡∏Ñ.</option><option value="8">‡∏™.‡∏Ñ.</option>
                                <option value="9">‡∏Å.‡∏¢.</option><option value="10">‡∏ï.‡∏Ñ.</option><option value="11">‡∏û.‡∏¢.</option><option value="12">‡∏ò.‡∏Ñ.</option>
                            </select>
                        </div>`;
            } else {
                html = `<div class="d-flex gap-2"><input type="date" id="inp-start" class="form-control form-control-sm"><input type="date" id="inp-end" class="form-control form-control-sm"></div>`;
            }
            container.innerHTML = html;
        }

        function getFilterDates() {
            const mode = document.getElementById('filter-mode').value;
            let start = "", end = "";
            
            if(mode === 'fiscal_year') {
                const y = parseInt(document.getElementById('inp-year').value);
                start = `${y-1}-10-01`; end = `${y}-10-01`;
            } 
            else if(mode === 'quarter') {
                const y = parseInt(document.getElementById('inp-year').value);
                const q = document.getElementById('inp-q').value;
                if(q == '1') { start = `${y-1}-10-01`; end = `${y-1}-12-31`; }
                else if(q == '2') { start = `${y}-01-01`; end = `${y}-04-01`; }
                else if(q == '3') { start = `${y}-04-01`; end = `${y}-07-01`; }
                else { start = `${y}-07-01`; end = `${y}-10-01`; }
            }
            else if(mode === 'month') {
                const y = parseInt(document.getElementById('inp-year').value);
                const m = parseInt(document.getElementById('inp-month').value);
                start = `${y}-${String(m).padStart(2,'0')}-01`;
                const nextM = m === 12 ? 1 : m + 1;
                const nextY = m === 12 ? y + 1 : y;
                end = `${nextY}-${String(nextM).padStart(2,'0')}-01`;
            }
            else {
                start = document.getElementById('inp-start').value;
                end = document.getElementById('inp-end').value;
            }
            return { s: start + "T00:00:00", e: end + "T23:59:59" };
        }

        // ================= DATA LOGIC =================
        async function loadConfigAndStats() {
            const resConf = await fetch(`${API_URL}?action=loadAdminApp&uid=${currentAdminUID}`);
            const dataConf = await resConf.json();
            if(dataConf.error) { alert("Access Denied"); return; }
            doctorsData = dataConf.doctors || [];
            
            // Build Dept Filter
            const deptSet = new Set();
            doctorsData.forEach(d => {
                if(d.specialties) d.specialties.forEach(s => deptSet.add(s));
            });
            const selDept = document.getElementById('filter-dept');
            deptSet.forEach(s => selDept.innerHTML += `<option value="${s}">${s}</option>`);

            loadStats();
        }

        async function loadStats() {
            const range = getFilterDates();
            document.getElementById('date-range-display').innerText = `Data Range: ${range.s.split('T')[0]} to ${range.e.split('T')[0]}`;
            
            const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}&start=${range.s}&end=${range.e}`);
            const result = await res.json();
            
            // Backend ‡∏™‡πà‡∏á‡∏°‡∏≤ 2 ‡∏™‡πà‡∏ß‡∏ô: table (‡∏£‡∏ß‡∏°) ‡πÅ‡∏•‡∏∞ graph (‡πÅ‡∏¢‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
            currentStats = result.table;
            currentGraphData = result.graph;

            applyLocalFilter(); // Render Table
            renderChart();      // Render Graph
        }

        function applyLocalFilter() {
            const fDept = document.getElementById('filter-dept').value;
            
            const tbodyGen = document.getElementById('tbody-gen');
            const tbodyGI = document.getElementById('tbody-gi');
            tbodyGen.innerHTML = ""; tbodyGI.innerHTML = "";

            doctorsData.forEach((doc, idx) => {
                // Filter Department Logic
                const docSpecs = (doc.specialties || []).map(s=>s.toString());
                if (fDept !== 'All' && !docSpecs.includes(fDept)) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á

                const s = currentStats.find(x => x.name === doc.name) || { c_first:0, c_follow:0, c_ugib:0, c_other:0, c_non:0 };
                const scoreGen = (s.c_first * doc.w_first) + (s.c_follow * doc.w_follow);
                const scoreGI = (s.c_ugib * doc.w_ugib) + (s.c_other * doc.w_other) + (s.c_non * doc.w_non);
                const specDisplay = doc.specialties ? doc.specialties.join(", ") : "-";

                // Gen Table
                tbodyGen.innerHTML += `
                    <tr>
                        <td class="text-start ps-4 fw-bold text-dark">${doc.name}</td>
                        <td><span class="badge bg-light text-dark border">${specDisplay}</span></td>
                        <td class="text-center">${s.c_first}</td>
                        <td class="text-center">${s.c_follow}</td>
                        <td class="text-center"><input type="number" step="0.1" class="form-control form-control-sm text-center mx-auto" style="width:60px" value="${doc.w_first}" onchange="updateLocalWeight(${idx}, 'w_first', this.value)"></td>
                        <td class="text-center"><input type="number" step="0.1" class="form-control form-control-sm text-center mx-auto" style="width:60px" value="${doc.w_follow}" onchange="updateLocalWeight(${idx}, 'w_follow', this.value)"></td>
                        <td class="text-center fw-bold text-primary">${scoreGen.toFixed(1)}</td>
                    </tr>
                `;

                // GI Table
                const isGI = docSpecs.some(s => s.toLowerCase().includes('gi') || s.toLowerCase().includes('gastro')) || s.c_ugib > 0;
                if (isGI) {
                    tbodyGI.innerHTML += `
                        <tr>
                            <td class="text-start ps-4 fw-bold text-dark">${doc.name}</td>
                            <td class="text-center text-danger bg-light">${s.c_ugib}</td>
                            <td class="text-center">${s.c_other}</td>
                            <td class="text-center">${s.c_non}</td>
                            <td class="text-center fw-bold text-danger">${scoreGI.toFixed(1)}</td>
                        </tr>
                    `;
                }
            });
        }

        function renderChart() {
            // currentGraphData structure: { "2026-01": {"Nephro": 10, "GI": 5}, ... }
            const ctx = document.getElementById('compChart');
            
            // 1. Prepare Labels (Sorted Months)
            const labels = Object.keys(currentGraphData).sort();
            
            // 2. Extract Unique Specialties
            const specialties = new Set();
            Object.values(currentGraphData).forEach(m => {
                Object.keys(m).forEach(s => specialties.add(s));
            });
            const specsArray = Array.from(specialties);

            // 3. Build Datasets
            const datasets = specsArray.map((spec, i) => {
                const data = labels.map(label => currentGraphData[label][spec] || 0);
                const color = `hsl(${(i * 360) / specsArray.length}, 70%, 50%)`; // Auto Color
                return {
                    label: spec,
                    data: data,
                    borderColor: color,
                    backgroundColor: color,
                    tension: 0.3,
                    fill: false
                };
            });

            if(compChart) compChart.destroy();
            compChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }

        function updateLocalWeight(idx, field, val) {
            doctorsData[idx][field] = parseFloat(val);
        }

        async function saveWeights() {
            const payload = doctorsData.map(d => ({
                docUID: d.uid,
                w_first: d.w_first, w_follow: d.w_follow,
                w_ugib: d.w_ugib, w_other: d.w_other, w_non: d.w_non
            }));
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateWeights', uid: currentAdminUID, payload: payload })
            });
            const r = await res.json();
            if(r.status === 'success') { alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadStats(); }
        }
    </script>
</body>
</html>
