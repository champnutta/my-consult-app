<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        .filter-box { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
        .cursor-pointer { cursor: pointer; }
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á Input Weight ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
        .input-weight { width: 60px; text-align: center; border: 1px solid #dee2e6; border-radius: 4px; padding: 2px; }
        .input-weight:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
    </style>
</head>
<body class="p-3">
    <div class="container" style="max-width: 1200px;">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary"><i class="bi bi-shield-lock"></i> Admin System</h4>
            <span id="admin-badge" class="badge bg-secondary">Checking...</span>
        </div>

        <div class="filter-box mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Global)</label>
                    <select id="filter-mode" class="form-select form-select-sm" onchange="renderFilterInputs()">
                        <option value="fiscal_year" selected>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="quarter">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option>
                        <option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div id="filter-inputs" class="row g-2"></div>
                </div>
                <div class="col-md-3">
                    <div class="small text-muted text-end pt-4" id="date-range-display">Loading...</div>
                </div>
                <div class="col-md-2 text-end">
                    <button onclick="loadStats()" class="btn btn-primary btn-sm w-100 fw-bold">
                        <i class="bi bi-arrow-repeat"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="gen-tab" data-bs-toggle="tab" data-bs-target="#gen-pane" type="button">üìä General PA</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="gi-tab-btn" data-bs-toggle="tab" data-bs-target="#gi-pane" type="button">ü©∏ GI Statistics</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="act-tab-btn" data-bs-toggle="tab" data-bs-target="#act-pane" type="button">üìù Activity Report</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            
            <div class="tab-pane fade show active" id="gen-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                        <th>New Case</th>
                                        <th>F/U</th>
                                        <th style="width: 80px;" class="small text-muted">Wt. New</th>
                                        <th style="width: 80px;" class="small text-muted">Wt. F/U</th>
                                        <th class="fw-bold text-primary">Total Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gen"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <button onclick="saveWeights()" class="btn btn-success btn-sm fw-bold">
                            <i class="bi bi-save"></i> Save Weights
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="gi-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th class="text-start ps-4">‡πÅ‡∏û‡∏ó‡∏¢‡πå (GI Only)</th>
                                        <th class="text-danger">UGIB</th>
                                        <th>Other GIB</th>
                                        <th>Non GIB</th>
                                        <th class="fw-bold text-danger">GI Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gi"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <small class="text-muted">* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå GI ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ GI ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</small>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="act-pane" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="small text-muted fw-bold">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="actView" id="view-summary" value="summary" checked onchange="renderActivityTab()">
                                    <label class="btn btn-outline-primary btn-sm" for="view-summary"><i class="bi bi-table"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</label>
                                    
                                    <input type="radio" class="btn-check" name="actView" id="view-detail" value="detail" onchange="renderActivityTab()">
                                    <label class="btn btn-outline-primary btn-sm" for="view-detail"><i class="bi bi-list-ul"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="small text-muted fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                <select id="act-filter-dept" class="form-select form-select-sm" onchange="renderActivityTab()">
                                    <option value="All">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="small text-muted fw-bold">‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
                                <select id="act-filter-doc" class="form-select form-select-sm" onchange="renderActivityTab()">
                                    <option value="All">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3 text-end align-self-end">
                                <span class="badge bg-info text-dark fs-6" id="act-total-badge">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="tbl-act-summary" class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                        <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th>
                                        <th class="text-end pe-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-act-summary"></tbody>
                            </table>

                            <table id="tbl-act-detail" class="table table-hover align-middle mb-0 d-none">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                                        <th>‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                        <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-act-detail"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // üî• ‡πÅ‡∏Å‡πâ URL Cloud Run ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô
        const API_URL = "https://smart-consult-api-890183822347.asia-southeast3.run.app"; 
        const LIFF_ID = "2008753162-pqFRi41y"; 

        let currentAdminUID = "";
        let doctorsData = [];
        let currentStats = []; 
        let currentActivities = []; 

        window.onload = async function() {
            renderFilterInputs();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentAdminUID = (await liff.getProfile()).userId;
                document.getElementById('admin-badge').innerText = "Admin Ready";
                document.getElementById('admin-badge').className = "badge bg-success";
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                loadConfigAndStats();
            } catch(e) { alert("LIFF Error: " + e); }
        }

        // ================= FILTER LOGIC (‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô) =================
        function renderFilterInputs() {
            const mode = document.getElementById('filter-mode').value;
            const container = document.getElementById('filter-inputs');
            const curY = new Date().getFullYear();
            let html = '';
            
            if(mode === 'fiscal_year') {
                html = `<select id="inp-year" class="form-select form-select-sm w-100">
                            <option value="${curY+1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY+1} (‡∏ï.‡∏Ñ. ${curY} - ‡∏Å.‡∏¢. ${curY+1})</option>
                            <option value="${curY}" selected>‡∏õ‡∏µ‡∏á‡∏ö ${curY} (‡∏ï.‡∏Ñ. ${curY-1} - ‡∏Å.‡∏¢. ${curY})</option>
                            <option value="${curY-1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY-1} (‡∏ï.‡∏Ñ. ${curY-2} - ‡∏Å.‡∏¢. ${curY-1})</option>
                        </select>`;
            } else if (mode === 'quarter') {
                html = `<div class="d-flex gap-2">
                            <select id="inp-year" class="form-select form-select-sm">
                                <option value="${curY}">${curY}</option>
                                <option value="${curY-1}">${curY-1}</option>
                            </select>
                            <select id="inp-q" class="form-select form-select-sm">
                                <option value="1">Q1 (‡∏ï.‡∏Ñ.-‡∏ò.‡∏Ñ.)</option>
                                <option value="2">Q2 (‡∏°.‡∏Ñ.-‡∏°‡∏µ.‡∏Ñ.)</option>
                                <option value="3">Q3 (‡πÄ‡∏°.‡∏¢.-‡∏°‡∏¥.‡∏¢.)</option>
                                <option value="4" selected>Q4 (‡∏Å.‡∏Ñ.-‡∏Å.‡∏¢.)</option>
                            </select>
                        </div>`;
            } else if (mode === 'month') {
                html = `<div class="d-flex gap-2">
                            <select id="inp-year" class="form-select form-select-sm">
                                <option value="${curY}" selected>${curY}</option>
                            </select>
                            <select id="inp-month" class="form-select form-select-sm">
                                <option value="1">‡∏°.‡∏Ñ.</option><option value="2">‡∏Å.‡∏û.</option><option value="3">‡∏°‡∏µ.‡∏Ñ.</option><option value="4">‡πÄ‡∏°.‡∏¢.</option>
                                <option value="5">‡∏û.‡∏Ñ.</option><option value="6">‡∏°‡∏¥.‡∏¢.</option><option value="7">‡∏Å.‡∏Ñ.</option><option value="8">‡∏™.‡∏Ñ.</option>
                                <option value="9">‡∏Å.‡∏¢.</option><option value="10">‡∏ï.‡∏Ñ.</option><option value="11">‡∏û.‡∏¢.</option><option value="12">‡∏ò.‡∏Ñ.</option>
                            </select>
                        </div>`;
            } else {
                html = `<div class="d-flex gap-2"><input type="date" id="inp-start" class="form-control form-control-sm"><input type="date" id="inp-end" class="form-control form-control-sm"></div>`;
            }
            container.innerHTML = html;
        }

        function getFilterDates() {
            const mode = document.getElementById('filter-mode').value;
            let start = "", end = "";
            const y = document.getElementById('inp-year') ? parseInt(document.getElementById('inp-year').value) : new Date().getFullYear();

            if(mode === 'fiscal_year') { start = `${y-1}-10-01`; end = `${y}-10-01`; } 
            else if(mode === 'quarter') {
                const q = document.getElementById('inp-q').value;
                if(q == '1') { start = `${y-1}-10-01`; end = `${y-1}-12-31`; }
                else if(q == '2') { start = `${y}-01-01`; end = `${y}-04-01`; }
                else if(q == '3') { start = `${y}-04-01`; end = `${y}-07-01`; }
                else { start = `${y}-07-01`; end = `${y}-10-01`; }
            }
            else if(mode === 'month') {
                const m = parseInt(document.getElementById('inp-month').value);
                start = `${y}-${String(m).padStart(2,'0')}-01`;
                const nextM = m === 12 ? 1 : m + 1;
                const nextY = m === 12 ? y + 1 : y;
                end = `${nextY}-${String(nextM).padStart(2,'0')}-01`;
            } else {
                start = document.getElementById('inp-start').value;
                end = document.getElementById('inp-end').value;
            }
            return { s: start + "T00:00:00", e: end + "T23:59:59" };
        }

        // --- DATA LOADING ---
        async function loadConfigAndStats() {
            // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞ Config
            const resConf = await fetch(`${API_URL}?action=loadAdminApp&uid=${currentAdminUID}`);
            const dataConf = await resConf.json();
            if(dataConf.error) { alert("Access Denied"); return; }
            doctorsData = dataConf.doctors || [];
            
            // Build Dept & Doctor Dropdowns for Activity Tab
            const deptSet = new Set();
            const docSel = document.getElementById('act-filter-doc');
            // Reset options
            docSel.innerHTML = '<option value="All">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>';
            document.getElementById('act-filter-dept').innerHTML = '<option value="All">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';

            doctorsData.forEach(d => {
                if(d.specialties) d.specialties.forEach(s => deptSet.add(s));
                docSel.innerHTML += `<option value="${d.name}">${d.name}</option>`;
            });
            deptSet.forEach(s => document.getElementById('act-filter-dept').innerHTML += `<option value="${s}">${s}</option>`);

            loadStats();
        }

        async function loadStats() {
            const range = getFilterDates();
            document.getElementById('date-range-display').innerText = `${range.s.split('T')[0]} - ${range.e.split('T')[0]}`;
            
            // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Backend
            const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}&start=${range.s}&end=${range.e}`);
            const result = await res.json();
            
            currentStats = result.table || [];
            currentActivities = result.activities || [];

            renderGeneralTabs(); // Tab 1 & 2
            renderActivityTab(); // Tab 3
        }

        // --- RENDER FUNCTIONS ---
        function renderGeneralTabs() {
            const tbodyGen = document.getElementById('tbody-gen');
            const tbodyGI = document.getElementById('tbody-gi');
            tbodyGen.innerHTML = ""; tbodyGI.innerHTML = "";

            doctorsData.forEach((doc, idx) => {
                const s = currentStats.find(x => x.name === doc.name) || { c_first:0, c_follow:0, c_ugib:0, c_other:0, c_non:0 };
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                const scoreGen = (s.c_first * doc.w_first) + (s.c_follow * doc.w_follow);
                const scoreGI = (s.c_ugib * doc.w_ugib) + (s.c_other * doc.w_other) + (s.c_non * doc.w_non);
                const specDisplay = doc.specialties ? doc.specialties.join(", ") : "-";

                // Tab 1: General
                tbodyGen.innerHTML += `
                    <tr>
                        <td class="text-start ps-4 fw-bold text-dark">${doc.name}</td>
                        <td><span class="badge bg-light text-dark border">${specDisplay}</span></td>
                        <td class="text-center">${s.c_first}</td>
                        <td class="text-center">${s.c_follow}</td>
                        <td class="text-center"><input type="number" step="0.1" class="input-weight" value="${doc.w_first}" onchange="updW(${idx}, 'w_first', this.value)"></td>
                        <td class="text-center"><input type="number" step="0.1" class="input-weight" value="${doc.w_follow}" onchange="updW(${idx}, 'w_follow', this.value)"></td>
                        <td class="text-center fw-bold text-primary">${scoreGen.toFixed(1)}</td>
                    </tr>
                `;

                // Tab 2: GI (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏≠ GI ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ GI)
                const docSpecs = (doc.specialties || []).map(s => s.toString().toLowerCase());
                const isGI = docSpecs.some(s => s.includes('gi') || s.includes('gastro')) || s.c_ugib > 0;
                
                if(isGI) {
                    tbodyGI.innerHTML += `
                        <tr>
                            <td class="text-start ps-4 fw-bold text-dark">${doc.name}</td>
                            <td class="text-center text-danger bg-light">${s.c_ugib}</td>
                            <td class="text-center">${s.c_other}</td>
                            <td class="text-center">${s.c_non}</td>
                            <td class="text-center fw-bold text-danger">${scoreGI.toFixed(1)}</td>
                        </tr>
                    `;
                }
            });
        }

        function renderActivityTab() {
            const viewMode = document.querySelector('input[name="actView"]:checked').value;
            const fDept = document.getElementById('act-filter-dept').value;
            const fDoc = document.getElementById('act-filter-doc').value;
            
            // Filter ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            let filteredAct = currentActivities.filter(act => {
                const docInfo = doctorsData.find(d => d.name === act.doctor);
                const docSpecs = docInfo ? (docInfo.specialties || []).map(s=>s.toString()) : [];
                
                if (fDept !== 'All' && !docSpecs.includes(fDept)) return false;
                if (fDoc !== 'All' && act.doctor !== fDoc) return false;
                return true;
            });

            document.getElementById('act-total-badge').innerText = `${filteredAct.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            const tblSummary = document.getElementById('tbl-act-summary');
            const tblDetail = document.getElementById('tbl-act-detail');
            const tbodySum = document.getElementById('tbody-act-summary');
            const tbodyDet = document.getElementById('tbody-act-detail');
            
            tbodySum.innerHTML = "";
            tbodyDet.innerHTML = "";

            if (viewMode === 'summary') {
                tblSummary.classList.remove('d-none');
                tblDetail.classList.add('d-none');

                // Group by Doctor
                const grouped = {};
                filteredAct.forEach(act => {
                    if(!grouped[act.doctor]) grouped[act.doctor] = { count: 0, name: act.doctor };
                    grouped[act.doctor].count++;
                });

                // Render Summary Row
                const sortedGroups = Object.values(grouped).sort((a,b)=>b.count - a.count);
                sortedGroups.forEach(g => {
                    const docInfo = doctorsData.find(d => d.name === g.name);
                    const specs = docInfo ? (docInfo.specialties || []).join(", ") : "-";
                    
                    tbodySum.innerHTML += `
                        <tr>
                            <td class="ps-4 fw-bold text-primary">${g.name}</td>
                            <td><span class="badge bg-light text-dark border">${specs}</span></td>
                            <td class="text-center fw-bold fs-5">${g.count}</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewDoctorDetail('${g.name}')">
                                    <i class="bi bi-eye"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                </button>
                            </td>
                        </tr>
                    `;
                });
                if(sortedGroups.length === 0) tbodySum.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;

            } else {
                tblSummary.classList.add('d-none');
                tblDetail.classList.remove('d-none');

                // Sort by Date (Newest first)
                filteredAct.sort((a,b) => new Date(b.date) - new Date(a.date));

                filteredAct.forEach(act => {
                    const d = act.date.split('T')[0];
                    tbodyDet.innerHTML += `
                        <tr>
                            <td class="ps-4 text-muted">${d}</td>
                            <td class="fw-bold">${act.activity}</td>
                            <td>${act.doctor}</td>
                            <td><span class="badge bg-secondary">${act.role}</span></td>
                        </tr>
                    `;
                });
                if(filteredAct.length === 0) tbodyDet.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
            }
        }

        // --- ACTIONS ---
        window.viewDoctorDetail = function(docName) {
            document.getElementById('act-filter-doc').value = docName;
            document.getElementById('view-detail').checked = true;
            renderActivityTab();
        }

        function updW(idx, field, val) { doctorsData[idx][field] = parseFloat(val); }
        
        async function saveWeights() {
            const btn = document.querySelector('button[onclick="saveWeights()"]');
            btn.innerHTML = "Saving..."; btn.disabled = true;
            
            const payload = doctorsData.map(d => ({
                docUID: d.uid, w_first: d.w_first, w_follow: d.w_follow, w_ugib: d.w_ugib, w_other: d.w_other, w_non: d.w_non
            }));
            
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateWeights', uid: currentAdminUID, payload: payload })
                });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Weight ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                loadStats();
            } catch(e) { alert("Error: "+e); }
            finally { btn.innerHTML = '<i class="bi bi-save"></i> Save Weights'; btn.disabled = false; }
        }
    </script>
</body>
</html>
