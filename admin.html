<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .nav-tabs .nav-link.active { font-weight: bold; border-bottom: 3px solid #0d6efd; color: #0d6efd; }
        .table-input { width: 70px; text-align: center; }
        .bg-head { background-color: #eef2f7; }
    </style>
</head>
<body class="p-3">
    <div class="container" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary"><i class="bi bi-shield-lock"></i> Admin Dashboard</h4>
            <span id="admin-badge" class="badge bg-secondary">Checking...</span>
        </div>

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-center">
                    <div class="col-auto fw-bold text-muted small">FILTER:</div>
                    <div class="col-auto">
                        <select id="filter-year" class="form-select form-select-sm" onchange="updateDateRange()"></select>
                    </div>
                    <div class="col-auto">
                        <select id="filter-month" class="form-select form-select-sm" onchange="loadStats()">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                    <div class="col text-end">
                        <button onclick="loadStats()" class="btn btn-primary btn-sm">Refresh</button>
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3 bg-white rounded shadow-sm px-2 pt-2" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-pane" type="button">üìä General PA</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gi-tab" data-bs-toggle="tab" data-bs-target="#gi-pane" type="button">ü©∏ GI Statistics</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="general-pane" role="tabpanel">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-head text-center">
                                    <tr>
                                        <th class="text-start ps-3">‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                                        <th>New Case</th>
                                        <th>F/U</th>
                                        <th class="text-muted small" style="width: 80px;">x New (2)</th>
                                        <th class="text-muted small" style="width: 80px;">x F/U (1)</th>
                                        <th class="fw-bold text-primary">Total Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-general"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <button onclick="saveWeights()" class="btn btn-success btn-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Weight</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="gi-pane" role="tabpanel">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-head text-center">
                                    <tr>
                                        <th class="text-start ps-3">‡πÅ‡∏û‡∏ó‡∏¢‡πå (GI)</th>
                                        <th class="text-danger">UGIB</th>
                                        <th>Other GIB</th>
                                        <th>Non GIB</th>
                                        <th class="fw-bold text-danger">GI Score</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-gi"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                         <small class="text-muted me-2">* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡∏Å GI ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ GI</small>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô Cloud Run ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô
        const API_URL = "https://smart-consult-api-890183822347.asia-southeast3.run.app"; 
        const LIFF_ID = "2008753162-pqFRi41y"; 

        let currentAdminUID = "";
        let doctorsData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö

        // Init App
        window.onload = async function() {
            initYearFilter();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentAdminUID = (await liff.getProfile()).userId;
                document.getElementById('admin-badge').innerText = "Admin: " + currentAdminUID.substring(0,5);
                document.getElementById('admin-badge').className = "badge bg-success";
                
                // ‡πÇ‡∏´‡∏•‡∏î 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á: Config(Weights) ‡πÅ‡∏•‡∏∞ Stats
                loadConfigAndStats();

            } catch(e) { alert("LIFF Error: " + e); }
        }

        function initYearFilter() {
            const sel = document.getElementById('filter-year');
            const curY = new Date().getFullYear();
            // ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏ó‡∏¢ = ‡∏õ‡∏µ ‡∏û.‡∏®. (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï.‡∏Ñ. 68 - ‡∏Å.‡∏¢. 69 ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏µ‡∏á‡∏ö 69)
            // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ä‡πâ ‡∏Ñ.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å: FY2026 = Oct 2025 - Sep 2026
            sel.innerHTML = `
                <option value="${curY+1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY+1} (Oct ${curY} - Sep ${curY+1})</option>
                <option value="${curY}" selected>‡∏õ‡∏µ‡∏á‡∏ö ${curY} (Oct ${curY-1} - Sep ${curY})</option>
                <option value="${curY-1}">‡∏õ‡∏µ‡∏á‡∏ö ${curY-1} (Oct ${curY-2} - Sep ${curY-1})</option>
            `;
        }

        async function loadConfigAndStats() {
            // 1. ‡∏î‡∏∂‡∏á Weight ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
            const resConf = await fetch(`${API_URL}?action=loadAdminApp&uid=${currentAdminUID}`);
            const dataConf = await resConf.json();
            if(dataConf.error) { alert("Access Denied"); return; }
            doctorsData = dataConf.doctors || [];

            // 2. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            loadStats(); 
        }

        async function loadStats() {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Start/End ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
            const year = parseInt(document.getElementById('filter-year').value);
            const month = document.getElementById('filter-month').value;
            
            let start, end;
            
            if (month === 'all') {
                // ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ‡∏á‡∏ö: 1 Oct (Year-1) ‡∏ñ‡∏∂‡∏á 1 Oct (Year)
                start = `${year-1}-10-01T00:00:00`;
                end = `${year}-10-01T00:00:00`;
            } else {
                // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                const m = parseInt(month);
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô >= 10 ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏µ Year-1, ‡∏ñ‡πâ‡∏≤ < 10 ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏µ Year
                const y = (m >= 10) ? year - 1 : year;
                // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                const nextM = (m === 12) ? 1 : m + 1;
                const nextY = (m === 12) ? y + 1 : y;
                
                start = `${y}-${String(m).padStart(2,'0')}-01T00:00:00`;
                end = `${nextY}-${String(nextM).padStart(2,'0')}-01T00:00:00`;
            }

            const res = await fetch(`${API_URL}?action=getAdminStats&uid=${currentAdminUID}&start=${start}&end=${end}`);
            const stats = await res.json();
            
            renderTables(stats);
        }

        function renderTables(stats) {
            // Merge stats ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö doctorsData (‡∏ó‡∏µ‡πà‡∏°‡∏µ weights)
            // stats = [{name: '‡∏´‡∏°‡∏≠ A', c_first: 5, ...}]
            
            const tbodyGen = document.getElementById('tbody-general');
            const tbodyGI = document.getElementById('tbody-gi');
            tbodyGen.innerHTML = ""; tbodyGI.innerHTML = "";

            doctorsData.forEach((doc, idx) => {
                // ‡∏´‡∏≤ stat ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
                const s = stats.find(x => x.name === doc.name) || { c_first:0, c_follow:0, c_ugib:0, c_other:0, c_non:0 };
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                const scoreGen = (s.c_first * (doc.w_first||2)) + (s.c_follow * (doc.w_follow||1));
                const scoreGI = (s.c_ugib * (doc.w_ugib||1)) + (s.c_other * (doc.w_other||1)) + (s.c_non * (doc.w_non||1));

                // 1. General Table
                tbodyGen.innerHTML += `
                    <tr>
                        <td class="text-start ps-3 fw-bold">${doc.name}</td>
                        <td class="text-center">${s.c_first}</td>
                        <td class="text-center">${s.c_follow}</td>
                        <td class="text-center"><input type="number" step="0.1" class="form-control form-control-sm text-center" value="${doc.w_first}" id="w_first_${idx}"></td>
                        <td class="text-center"><input type="number" step="0.1" class="form-control form-control-sm text-center" value="${doc.w_follow}" id="w_follow_${idx}"></td>
                        <td class="text-center fw-bold text-primary">${scoreGen.toFixed(1)}</td>
                        
                        <input type="hidden" id="w_ugib_${idx}" value="${doc.w_ugib}">
                        <input type="hidden" id="w_other_${idx}" value="${doc.w_other}">
                        <input type="hidden" id="w_non_${idx}" value="${doc.w_non}">
                        <input type="hidden" id="uid_${idx}" value="${doc.uid}">
                    </tr>
                `;

                // 2. GI Table (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏≠ GI ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ GI)
                const specs = (doc.specialties || "").toString().toLowerCase();
                const isGI = specs.includes('gi') || specs.includes('gastro') || s.c_ugib > 0 || s.c_other > 0;
                
                if (isGI) {
                    tbodyGI.innerHTML += `
                        <tr>
                            <td class="text-start ps-3 fw-bold">${doc.name}</td>
                            <td class="text-center text-danger bg-light">${s.c_ugib}</td>
                            <td class="text-center">${s.c_other}</td>
                            <td class="text-center">${s.c_non}</td>
                            <td class="text-center fw-bold text-danger">${scoreGI.toFixed(1)}</td>
                        </tr>
                    `;
                }
            });
        }

        async function saveWeights() {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ update array
            const payload = doctorsData.map((d, idx) => ({
                docUID: document.getElementById(`uid_${idx}`).value,
                w_first: document.getElementById(`w_first_${idx}`).value,
                w_follow: document.getElementById(`w_follow_${idx}`).value,
                w_ugib: document.getElementById(`w_ugib_${idx}`).value,
                w_other: document.getElementById(`w_other_${idx}`).value,
                w_non: document.getElementById(`w_non_${idx}`).value
            }));

            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateWeights', uid: currentAdminUID, payload: payload })
            });
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            loadStats(); // reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠ update ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        }
    </script>
</body>
</html>
